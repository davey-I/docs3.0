<!DOCTYPE html>
<html><head>
<title data-folder-path="/Tocco">Tocco-Ansible</title>
<link href=" ../../static/style.css" rel="stylesheet"/>
<link href="../../prism/prism.css" rel="stylesheet"/>
</head>
<body class="body">
<div class="page-folder-header-div">
<h1 class="pagetitle" data-folder-path="Tocco">Tocco-Ansible</h1>
<a href="./../..">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M3 11L12 4L21 11"></path>
<path d="M5 10V20H19V10"></path>
<path d="M10 20V14H14V20"></path>
</svg>
</a>
</div>
<!-- Sidebar -->
<div class="sidbear-enclosure-open" id="sidbear-enclosure-open-Tocco-Ansible">
<button class="sidbear-enclosure-button-open" id="sidbear-enclosure-button-Tocco-Ansible" onclick="toggle_sidebar()" type="button">
<svg fill="white" height="30" viewBox="0 0 100 80" width="30" xmlns="http://www.w3.org/2000/svg">
<rect height="10" width="100"></rect>
<rect height="10" width="100" y="30"></rect>
<rect height="10" width="100" y="60"></rect>
</svg>
</button>
<div class="sidebar-mainbox-open" id="sidebar-mainbox-Tocco-Ansible">
<div class="sidebar-subbox-open" id="sidebar-subbox-1" onclick=" append_foldable_content()">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="10"></circle>
<line x1="12" x2="12" y1="8" y2="16"></line>
<line x1="8" x2="16" y1="12" y2="12"></line>
</svg>
</div>
<div class="sidebar-subbox-open" id="sidebar-subbox-2">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="10"></circle>
<path d="M9.09 9C9.32591 8.33109 9.78918 7.76807 10.4 7.41421C11.0108 7.06036 11.7266 6.93913 12.4152 7.07107C13.1038 7.20302 13.7206 7.57857 14.162 8.12132C14.6034 8.66407 14.8397 9.33984 14.83 10.03C14.83 12 12.5 12.5 12.5 14"></path>
<circle cx="12" cy="17" r="1"></circle>
</svg>
</div>
<div class="sidebar-subbox-open" id="sidebar-subbox-3">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="10"></circle>
<path d="M9.09 9C9.32591 8.33109 9.78918 7.76807 10.4 7.41421C11.0108 7.06036 11.7266 6.93913 12.4152 7.07107C13.1038 7.20302 13.7206 7.57857 14.162 8.12132C14.6034 8.66407 14.8397 9.33984 14.83 10.03C14.83 12 12.5 12.5 12.5 14"></path>
<circle cx="12" cy="17" r="1"></circle>
</svg>
</div>
</div>
</div>
<script src="../../prism/prism.js"></script>
<script src="../../static/script.js"></script>
<!--## Adjust-Memory-RAM #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-Adjust-Memory-RAM">
<h2 class="foldable-title" id="foldable-title-Adjust-Memory-RAM">Adjust-Memory-RAM</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('Adjust-Memory-RAM')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-Ansible','editable-paragraph-Adjust-Memory-RAM', 'foldable-content-penButton-Adjust-Memory-RAM')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<button class="create-subdiv" id="create-subdiv-Adjust-Memory-RAM" onclick="add_subdiv('editable-paragraph-Adjust-Memory-RAM')" type='*button"'>
<svg class="add-tag-icon" fill="none" height="22" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
<!-- < and > symbols -->
<path d="M6 8l-4 4 4 4"></path> <!-- Left angle bracket -->
<path d="M18 8l4 4-4 4"></path> <!-- Right angle bracket -->
<!-- Plus sign in center -->
<path d="M12 10v4"></path>
<path d="M10 12h4"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-Adjust-Memory-RAM">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-Adjust-Memory-RAM" onclick="save_editable_content('Tocco-Ansible','editable-paragraph-Adjust-Memory-RAM', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-Adjust-Memory-RAM"><pre><b>Check Memory Stats with:</b>
<pre><code class="lang-bash">
Â https://${CUSTOMERNAME}.tocco.ch/status-tocco
tco status ${CUSTOMERNAME}Â 
tco mem ${CUSTOMERNAME}
</code>
</pre>
<b>Note that the application reports heap-memory
Â  Â  Â  Â only which should be ~43% of what you set.
</b>

- The values displayed by https://azek.tocco.ch/status-tocco
are in MB, and need to be divided by <i>factor 0.43</i> (MB-Value /<i>0.43</i> = 3.4 GiB)

<h3>Connection between Stage and Prod Memory </h3>
- Ram of <i>Productive System</i> is coupled with <b>Test System</b>

- If RAM of <i>Productive System</i> has no extra entrance in memory: ...
Â  The Default value 3.4 GiB gets set.

- The <b>Test System</b>Â is then a %-Value
Â  of whatever value is set in <i>Productive System</i>,
Â  If nothing is explicitly set in <b>Test System</b>Â -&gt; memory: ...
Â  (for ex. 2.4GiB if Prod. is default)

- If something is set in <b>Test System</b>Â -&gt; memory: ...
Â  Then this value is taken, without any coupling
Â  to the Prod. System.

- Additional analysis tool: <a href="https://docs.tocco.ch/devops/nice/jmx.html">JMX / visualVM / JConsole </a>

Also check <a href="https://docs.tocco.ch/devops/app_management/ansible_memory.html#index-0">Tocco-Docs : RAM-Setting</a>

<h3>Adjust Memory </h3>
<ul>
<li> Add / update memory setting in config.yml for prod.</li>
<li> Run the playbook against the customer (-l customer_azek)Â 
( test is adjusted auto. based on prod. because <b>customer_</b>.) </li>
<li> Maybe Commit change and open merge requests.</li>
</ul>
<h3>Create Ticket if OOM</h3>
Memory-Dumps can be found atÂ 
<pre><code class="lang-bash">

s3cmd ls -r s3://memory-dumps/nice-${CUSTOMERNAME}
for exÂ 
s3cmd ls -r s3://memory-dumps/nice-holzbautest

</code>
Or check commands at <a href="https://docs.tocco.ch/devops/nice/thread_and_memory_dumps.html#creating-memory-dump-on-oom">Tocco-Docs</a>
</pre>
-Â check if there is already a ticket (in time period smaller than ~2W) that concerns the same issue.
- Create ticket at <b>Location : Tocco Development / Add Epic / TOCDEV-8234</b>
Â  Â <div style="border-style:solid;">
Â  Â  Memory Dump analysieren fÃ¼r odaszh
Â  Â  Description
Â  Â  Bei der produktiven LÃ¶sung von ${CUSTOMERNAME}Â kommt es immer mal wieder zu einem Out-of-Memory (OOM) Fehler.
Â  Â  Die LÃ¶sung hat aktuell 6 GB RAM zurVerfÃ¼gung.
Â  Â  Kann sich bitte jemand bei Gelegenheit anschauen, was dort das RAM fÃ¼llen kÃ¶nnte?
Â  Â  Den Memory Dump kÃ¶nnt Ihr anhand dieser Anleitung herunterladen (Punkt 3: list dumps Anleitung ):
Â  Â  Vielen Dank!
Â  Â </div>
-Â Diesem Ticket dann <i>OPS-690</i> als parent zuweisen. Und mit anderem Ticket verlinken.

</pre></div>
</div>
</div>
<!--## Add-New-Domain #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-Add-New-Domain">
<h2 class="foldable-title" id="foldable-title-Add-New-Domain">Add-New-Domain</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('Add-New-Domain')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-Ansible','editable-paragraph-Add-New-Domain', 'foldable-content-penButton-Add-New-Domain')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<button class="create-subdiv" id="create-subdiv-Add-New-Domain" onclick="add_subdiv('editable-paragraph-Add-New-Domain')" type='*button"'>
<svg class="add-tag-icon" fill="none" height="22" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
<!-- < and > symbols -->
<path d="M6 8l-4 4 4 4"></path> <!-- Left angle bracket -->
<path d="M18 8l4 4-4 4"></path> <!-- Right angle bracket -->
<!-- Plus sign in center -->
<path d="M12 10v4"></path>
<path d="M10 12h4"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-Add-New-Domain">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-Add-New-Domain" onclick="save_editable_content('Tocco-Ansible','editable-paragraph-Add-New-Domain', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-Add-New-Domain"><h1>TITLE IPSUM</h1>
<!--## Single-Domain #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-Single-Domain">
<h2 class="foldable-title" id="foldable-title-Single-Domain">Single-Domain</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('Single-Domain')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-Ansible','editable-paragraph-Single-Domain', 'foldable-content-penButton-Single-Domain')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-Single-Domain">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-Single-Domain" onclick="save_editable_content('Tocco-Ansible','editable-paragraph-Single-Domain', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-Single-Domain"><pre>- Customers have a new domain, that needs to be connected to the installation.


- First we need to check the NS


- The DNS Zone of the Domain needs to somehow point towards Tocco.
Â  (fasc: "das isch nur denn de fall wenn d website ih euisem tocco redaktionssystem drin isch" )


- Third we need to make Two changes to the Ansible-Config.
Â  By searching the installation and then add the domain
Â  once -&gt; with <i>www.</i>
Â  once -&gt; only <i>domain.ch</i>
Â  <b>Missing Ansible-Config entrance is also noticeable if the https: call displays a cert-error.</b>


- One last thing is that the domain needs to be set in some Tocco-Installation internal, but this is usually done by BS


- If success, the domain should be accessible via http: on browser without a cert error.
</pre></div>
</div>
</div>
<!--## Widget-Testdomain-Mida #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-Widget-Testdomain-Mida">
<h2 class="foldable-title" id="foldable-title-Widget-Testdomain-Mida">Widget-Testdomain-Mida</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('Widget-Testdomain-Mida')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-Ansible','editable-paragraph-Widget-Testdomain-Mida', 'foldable-content-penButton-Widget-Testdomain-Mida')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-Widget-Testdomain-Mida">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-Widget-Testdomain-Mida" onclick="save_editable_content('Tocco-Ansible','editable-paragraph-Widget-Testdomain-Mida', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-Widget-Testdomain-Mida"><pre>- Mida wants so test widgets on his own server sometimes (deex.cch)


- Therefore we create a new entrance underneath <i>routes:</i>
Â  Â the corresponding test system and we add: <b>tocco.toc-example.deex.ch</b>


- Then mida has to create a CNAME at deex.ch s DNS-Zone


- If we get some kind of Error saying:
<b>"...Access-Control-Allow-Origin' header is present on the
requested resource. If an opaque response serves your needs, set the
request's mode to 'no-cors' to fetch the resource with CORS disabled"</b>


- We also need to add the domain with <b>https://tocco.toc-example.deex.ch</b>
underneath: <i>nice2.web.allowedRequestOrigins:</i>Â 
(not with <b>env:</b> anymore. See also: <a href="">this</a>


<div style="border-style:solid; border-color:yellow">
Â  Â Sometimes it can be a problem, that some entrances are cashed, and because of that the
Â  Â DNS-Changes are not present yet. Cashed at network / DNS-Provider.


Â  Â This is especially then suspicious, when we do aÂ 
Â  Â dig @ the Nameserver of the Domain-Hoster itselfe and get a different result.


Â  Â dig @ns1.cyon.ch $DOMAIN vs. dig $DOMAINÂ 


Â  Â Then we just have to wait and try again later.

</div>


</pre></div>
</div>
</div>
<!--## Domain-With-Wordpress #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-Domain-With-Wordpress">
<h2 class="foldable-title" id="foldable-title-Domain-With-Wordpress">Domain-With-Wordpress</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('Domain-With-Wordpress')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-Ansible','editable-paragraph-Domain-With-Wordpress', 'foldable-content-penButton-Domain-With-Wordpress')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-Domain-With-Wordpress">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-Domain-With-Wordpress" onclick="save_editable_content('Tocco-Ansible','editable-paragraph-Domain-With-Wordpress', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-Domain-With-Wordpress"><pre>- Basically the same as @mida specialexample.
- We need to create two entrances into routes:
Â  Â  Â Single Domain name
Â  Â  Â Ingress = False entrance


- For Example:
<pre><code class="lang-bash">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  routes:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  web.cwbtest-temp.tocco.ch:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â create_ingress: falseÂ  Â  Â  Â  Â  Â  # WordPress pages using our widgets
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tocco.web.cwbtest-temp.tocco.ch:'
</code>
</pre>
or
<pre><code class="lang-bash">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  routes:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  test-my.swissengineering.ch:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  create_ingress: falseÂ  Â  Â  Â  Â  # WordPress pages using our widgets
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tocco.test-my.swissengineering.ch:
</code>
</pre>
<b>Why is this needed after all ?</b>
<div style="border-style:solid;">


Â  Â Without create_ingress: false a new Cert. would be created via Openshift.
Â  Â LetsEncrypt always needs a location where a special file is present
Â  Â With certain content. Because the route leads to a Server
Â  Â That has nothing to do with Openshift, this would fail.


</div>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<!--## playbook-run-limitations #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-playbook-run-limitations">
<h2 class="foldable-title" id="foldable-title-playbook-run-limitations">playbook-run-limitations</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('playbook-run-limitations')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-Ansible','editable-paragraph-playbook-run-limitations', 'foldable-content-penButton-playbook-run-limitations')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<button class="create-subdiv" id="create-subdiv-playbook-run-limitations" onclick="add_subdiv('editable-paragraph-playbook-run-limitations')" type='*button"'>
<svg class="add-tag-icon" fill="none" height="22" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
<!-- < and > symbols -->
<path d="M6 8l-4 4 4 4"></path> <!-- Left angle bracket -->
<path d="M18 8l4 4-4 4"></path> <!-- Right angle bracket -->
<!-- Plus sign in center -->
<path d="M12 10v4"></path>
<path d="M10 12h4"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-playbook-run-limitations">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-playbook-run-limitations" onclick="save_editable_content('Tocco-Ansible','editable-paragraph-playbook-run-limitations', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-playbook-run-limitations"><pre><h4>Limit for Customer (run fo <i>prod</i> and <i>stage</i>)</h4>


<b>-l customer_${CUSTOMERNAME}</b>
for ex:Â <b>-l customer_avanti</b>
</pre></div>
</div>
</div>
<!--## processing-pipeline #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-processing-pipeline">
<h2 class="foldable-title" id="foldable-title-processing-pipeline">processing-pipeline</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('processing-pipeline')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-Ansible','editable-paragraph-processing-pipeline', 'foldable-content-penButton-processing-pipeline')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<button class="create-subdiv" id="create-subdiv-processing-pipeline" onclick="add_subdiv('editable-paragraph-processing-pipeline')" type='*button"'>
<svg class="add-tag-icon" fill="none" height="22" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
<!-- < and > symbols -->
<path d="M6 8l-4 4 4 4"></path> <!-- Left angle bracket -->
<path d="M18 8l4 4-4 4"></path> <!-- Right angle bracket -->
<!-- Plus sign in center -->
<path d="M12 10v4"></path>
<path d="M10 12h4"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-processing-pipeline">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-processing-pipeline" onclick="save_editable_content('Tocco-Ansible','editable-paragraph-processing-pipeline', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-processing-pipeline"><div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f5f5f5;">
Â  <h1 style="color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px;">Ansible Dynamic Inventory Pipeline: Complete Processing Flow</h1>
Â Â 
Â  <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
Â  Â  <h2 style="color: #2980b9; margin-top: 0;">ğŸ—ï¸ Architecture Overview</h2>
Â  Â  <p style="line-height: 1.8; font-size: 16px;">Your Ansible setup uses a <strong>dynamic inventory script</strong> (<code style="background: #ecf0f1; padding: 3px 8px; border-radius: 3px;">inventory.py</code>) that reads YAML configuration files and generates inventory data on-the-fly. This architecture enables flexible, programmatic inventory management but has specific rules about when and where templating occurs.</p>
Â  </div>


Â  <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; margin: 20px 0; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
Â  Â  <h2 style="margin-top: 0;">ğŸ“Š The Complete Pipeline</h2>
Â  Â  <p style="font-size: 18px; opacity: 0.95;">From YAML files to playbook execution - here's what happens at each stage:</p>
Â  </div>


Â  <!-- Stage 1 -->
Â  <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid #3498db;">
Â  Â  <h3 style="color: #3498db; margin-top: 0;">Stage 1: File System - YAML Configuration Files</h3>
Â  Â Â 
Â  Â  <div style="background: #ecf0f1; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #2c3e50;">Files Involved:</h4>
Â  Â  Â  <ul style="line-height: 1.8;">
Â  Â  Â  Â  <li><code style="background: white; padding: 2px 6px; border-radius: 3px;">config.yml</code> - Customer and installation definitions</li>
Â  Â  Â  Â  <li><code style="background: white; padding: 2px 6px; border-radius: 3px;">global.yml</code> - Global configuration and variables</li>
Â  Â  Â  </ul>
Â  Â  </div>


Â  Â  <div style="background: #e8f4f8; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #2980b9;">What's in these files:</h4>
Â  Â  Â  <ul style="line-height: 1.8;">
Â  Â  Â  Â  <li><strong>Pure YAML data structures</strong> (dictionaries, lists, strings)</li>
Â  Â  Â  Â  <li><strong>Jinja2 template syntax</strong> (in string values: <code style="background: white; padding: 2px 6px; border-radius: 3px;">{{ variables }}</code>, <code style="background: white; padding: 2px 6px; border-radius: 3px;">{% control structures %}</code>)</li>
Â  Â  Â  Â  <li><strong>Configuration data</strong> (routes, environment variables, deployment settings)</li>
Â  Â  Â  </ul>
Â  Â  </div>


Â  Â  <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 3px solid #ffc107;">
Â  Â  Â  <h4 style="margin-top: 0; color: #856404;">âš ï¸ Important Constraint:</h4>
Â  Â  Â  <p style="margin: 0; line-height: 1.6;"><strong>At this stage, Jinja2 syntax is just text.</strong> The files contain literal strings like <code style="background: white; padding: 2px 6px; border-radius: 3px;">{{ webserver_prefix }}</code> - they haven't been processed yet. The YAML parser doesn't understand Jinja2.</p>
Â  Â  </div>


Â  Â  <div style="background: #d4edda; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 3px solid #28a745;">
Â  Â  Â  <h4 style="margin-top: 0; color: #155724;">âœ… Key Point:</h4>
Â  Â  Â  <p style="margin: 0; line-height: 1.6;">YAML syntax must be valid regardless of Jinja2 content. This means problematic characters like <code style="background: white; padding: 2px 6px; border-radius: 3px;">{</code>, <code style="background: white; padding: 2px 6px; border-radius: 3px;">[</code>, <code style="background: white; padding: 2px 6px; border-radius: 3px;">:</code> in keys or unquoted values need to be quoted or the YAML parser will fail.</p>
Â  Â  </div>
Â  </div>


Â  <!-- Stage 2 -->
Â  <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid #9b59b6;">
Â  Â  <h3 style="color: #9b59b6; margin-top: 0;">Stage 2: Python - YAML Parsing (inventory.py)</h3>
Â  Â Â 
Â  Â  <div style="background: #f3e5f5; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #6a1b9a;">What happens:</h4>
Â  Â  Â  <pre style="background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 4px; overflow-x: auto; line-height: 1.5;">with (Path(__file__).parent / 'config.yml').open() as f:
Â  Â  definitions = load_yaml(f)
with (Path(__file__).parent / 'global.yml').open() as f:
Â  Â  global_config = load_yaml(f)</pre>
Â  Â  </div>


Â  Â  <div style="background: #e8f4f8; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #2980b9;">The load_yaml() function:</h4>
Â  Â  Â  <ol style="line-height: 1.8;">
Â  Â  Â  Â  <li><strong>Reads file as text</strong> - Opens the file and reads raw content</li>
Â  Â  Â  Â  <li><strong>YAML parsing</strong> - Uses Python's <code style="background: white; padding: 2px 6px; border-radius: 3px;">yaml</code> library (likely PyYAML)</li>
Â  Â  Â  Â  <li><strong>Converts to Python objects</strong> - YAML â†’ Python dicts, lists, strings, etc.</li>
Â  Â  Â  </ol>
Â  Â  </div>


Â  Â  <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 3px solid #ffc107;">
Â  Â  Â  <h4 style="margin-top: 0; color: #856404;">âš ï¸ Critical Behavior:</h4>
Â  Â  Â  <p style="margin: 0 0 10px 0; line-height: 1.6;"><strong>NO Jinja2 processing happens here!</strong></p>
Â  Â  Â  <p style="margin: 0; line-height: 1.6;">The YAML parser treats Jinja2 syntax as literal strings. If your YAML value is <code style="background: white; padding: 2px 6px; border-radius: 3px;">"{{ variable }}"</code>, the Python dictionary will contain the literal string <code style="background: white; padding: 2px 6px; border-radius: 3px;">"{{ variable }}"</code> including the curly braces.</p>
Â  Â  </div>


Â  Â  <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #1565c0;">Example:</h4>
Â  Â  Â  <p style="margin: 5px 0;"><strong>YAML input:</strong></p>
Â  Â  Â  <pre style="background: #2c3e50; color: #ecf0f1; padding: 12px; border-radius: 4px; overflow-x: auto;">nginx_envs:
Â  CSP_HEADER: "{{ csp_policy }}"
Â  webserver: "{{ webserver_prefix }}"</pre>
Â  Â  Â  <p style="margin: 15px 0 5px 0;"><strong>Python output:</strong></p>
Â  Â  Â  <pre style="background: #2c3e50; color: #ecf0f1; padding: 12px; border-radius: 4px; overflow-x: auto;">{
Â  Â  'nginx_envs': {
Â  Â  Â  Â  'CSP_HEADER': '{{ csp_policy }}',
Â  Â  Â  Â  'webserver': '{{ webserver_prefix }}'
Â  Â  }
}</pre>
Â  Â  </div>
Â  </div>


Â  <!-- Stage 3 -->
Â  <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid #e67e22;">
Â  Â  <h3 style="color: #e67e22; margin-top: 0;">Stage 3: Python - Inventory Construction</h3>
Â  Â Â 
Â  Â  <div style="background: #fef5e7; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #d68910;">What happens:</h4>
Â  Â  Â  <p style="line-height: 1.6;">The <code style="background: white; padding: 2px 6px; border-radius: 3px;">main()</code> function builds the Ansible inventory structure:</p>
Â  Â  Â  <pre style="background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 4px; overflow-x: auto; line-height: 1.5;">inventory = {
Â  Â  '_meta': {'hostvars': {}},
Â  Â  'all': {'children': ['tocco_installations', 'wordpress_instances']},
Â  Â  'tocco_installations': {'children': []},
Â  Â  'wordpress_instances': {'hosts': []},
}</pre>
Â  Â  </div>


Â  Â  <div style="background: #e8f4f8; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #2980b9;">Processing Steps:</h4>
Â  Â  Â  <ol style="line-height: 1.8;">
Â  Â  Â  Â  <li><strong>Iterate through customers</strong> in <code style="background: white; padding: 2px 6px; border-radius: 3px;">config.yml</code></li>
Â  Â  Â  Â  <li><strong>For each customer, iterate through installations</strong></li>
Â  Â  Â  Â  <li><strong>Build host variables (hostvars)</strong> for each installation:
Â  Â  Â  Â  Â  <pre style="background: #2c3e50; color: #ecf0f1; padding: 12px; border-radius: 4px; overflow-x: auto; margin: 10px 0;">vars = hostvars.setdefault(inst, {})
merge_vars(vars, global_config)Â  # â† global.yml merged here
merge_vars(vars, cust_config)
merge_vars(vars, inst_config)</pre>
Â  Â  Â  Â  </li>
Â  Â  Â  Â  <li><strong>Add computed values</strong> (customer_name, installation_name, sibling_installations)</li>
Â  Â  Â  Â  <li><strong>Process routes and WordPress instances</strong></li>
Â  Â  Â  </ol>
Â  Â  </div>


Â  Â  <div style="background: #d4edda; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 3px solid #28a745;">
Â  Â  Â  <h4 style="margin-top: 0; color: #155724;">âœ… Key Behavior:</h4>
Â  Â  Â  <p style="margin: 0; line-height: 1.6;"><strong>Configuration hierarchy:</strong> Variables are merged in order (global â†’ customer â†’ installation). Later values override earlier ones. This happens at the Python dictionary level - still no Jinja2 processing.</p>
Â  Â  </div>


Â  Â  <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #1565c0;">Result:</h4>
Â  Â  Â  <p style="line-height: 1.6;">A complete inventory data structure with:</p>
Â  Â  Â  <ul style="line-height: 1.8;">
Â  Â  Â  Â  <li><strong>Groups:</strong> customer groups, tocco_installations, wordpress_instances</li>
Â  Â  Â  Â  <li><strong>Hosts:</strong> Installation names and WordPress host names</li>
Â  Â  Â  Â  <li><strong>Host variables (hostvars):</strong> All configuration for each host, with Jinja2 syntax still as literal strings</li>
Â  Â  Â  </ul>
Â  Â  </div>
Â  </div>


Â  <!-- Stage 4 -->
Â  <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid #e74c3c;">
Â  Â  <h3 style="color: #e74c3c; margin-top: 0;">Stage 4: Python â†’ Ansible - JSON Serialization</h3>
Â  Â Â 
Â  Â  <div style="background: #ffebee; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #c62828;">What happens:</h4>
Â  Â  Â  <pre style="background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 4px; overflow-x: auto; line-height: 1.5;">json.dump(data_to_print, sys.stdout, indent=True)
sys.stdout.write('\n')</pre>
Â  Â  Â  <p style="margin: 10px 0 0 0; line-height: 1.6;">The entire inventory structure is serialized to JSON and written to stdout.</p>
Â  Â  </div>


Â  Â  <div style="background: #e8f4f8; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #2980b9;">JSON Output Format:</h4>
Â  Â  Â  <pre style="background: #2c3e50; color: #ecf0f1; padding: 12px; border-radius: 4px; overflow-x: auto; font-size: 14px; line-height: 1.5;">{
Â  "_meta": {
Â  Â  "hostvars": {
Â  Â  Â  "installation_name": {
Â  Â  Â  Â  "customer_name": "customer1",
Â  Â  Â  Â  "installation_name": "installation_name",
Â  Â  Â  Â  "nginx_envs": {
Â  Â  Â  Â  Â  "CSP_HEADER": "{{ csp_policy }}",
Â  Â  Â  Â  Â  "PREFIX": "{{ webserver_prefix }}"
Â  Â  Â  Â  },
Â  Â  Â  Â  "webserver_prefix": "APACHE2",
Â  Â  Â  Â  "csp_policy": "default-src 'self';",
Â  Â  Â  Â  "routes": {...},
Â  Â  Â  Â  "state": "present",
Â  Â  Â  Â  "__type": "nice"
Â  Â  Â  }
Â  Â  }
Â  },
Â  "all": {"children": ["tocco_installations", "wordpress_instances"]},
Â  "tocco_installations": {"children": ["customer_customer1"]},
Â  "customer_customer1": {"hosts": ["installation_name"]}
}</pre>
Â  Â  </div>


Â  Â  <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 3px solid #ffc107;">
Â  Â  Â  <h4 style="margin-top: 0; color: #856404;">âš ï¸ Important:</h4>
Â  Â  Â  <p style="margin: 0; line-height: 1.6;">Jinja2 syntax is <strong>still literal strings</strong> in the JSON. The <code style="background: white; padding: 2px 6px; border-radius: 3px;">{{ }}</code> and <code style="background: white; padding: 2px 6px; border-radius: 3px;">{% %}</code> are just characters in string values at this point.</p>
Â  Â  </div>
Â  </div>


Â  <!-- Stage 5 -->
Â  <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid #16a085;">
Â  Â  <h3 style="color: #16a085; margin-top: 0;">Stage 5: Ansible - Inventory Loading</h3>
Â  Â Â 
Â  Â  <div style="background: #e8f8f5; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #138d75;">What happens:</h4>
Â  Â  Â  <ol style="line-height: 1.8;">
Â  Â  Â  Â  <li><strong>Ansible executes inventory.py</strong> as a subprocess</li>
Â  Â  Â  Â  <li><strong>Reads JSON from stdout</strong></li>
Â  Â  Â  Â  <li><strong>Parses JSON</strong> into internal Ansible data structures</li>
Â  Â  Â  Â  <li><strong>Creates inventory objects:</strong>
Â  Â  Â  Â  Â  <ul style="margin-top: 8px;">
Â  Â  Â  Â  Â  Â  <li>Host objects</li>
Â  Â  Â  Â  Â  Â  <li>Group objects</li>
Â  Â  Â  Â  Â  Â  <li>Variable storage (VariableManager)</li>
Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  </li>
Â  Â  Â  </ol>
Â  Â  </div>


Â  Â  <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 3px solid #ffc107;">
Â  Â  Â  <h4 style="margin-top: 0; color: #856404;">âš ï¸ Critical Point:</h4>
Â  Â  Â  <p style="margin: 0; line-height: 1.6;"><strong>Ansible does NOT template inventory data at load time.</strong> The variables are stored exactly as received from the JSON. Jinja2 processing happens later, during playbook execution.</p>
Â  Â  </div>


Â  Â  <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #1565c0;">What Ansible Has Now:</h4>
Â  Â  Â  <ul style="line-height: 1.8;">
Â  Â  Â  Â  <li>Complete inventory graph (hosts, groups, relationships)</li>
Â  Â  Â  Â  <li>Variable storage with literal Jinja2 syntax strings</li>
Â  Â  Â  Â  <li>No knowledge yet of what those variables will become when templated</li>
Â  Â  Â  </ul>
Â  Â  </div>
Â  </div>


Â  <!-- Stage 6 -->
Â  <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid #27ae60;">
Â  Â  <h3 style="color: #27ae60; margin-top: 0;">Stage 6: Ansible - Playbook Execution (Jinja2 Magic! âœ¨)</h3>
Â  Â Â 
Â  Â  <div style="background: #e8f8e8; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #1e8449;">This is where Jinja2 finally activates!</h4>
Â  Â  Â  <p style="line-height: 1.6;">When a playbook runs and tasks need variable values, Ansible's templating engine processes them.</p>
Â  Â  </div>


Â  Â  <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #1565c0;">Example Task:</h4>
Â  Â  Â  <pre style="background: #2c3e50; color: #ecf0f1; padding: 12px; border-radius: 4px; overflow-x: auto; line-height: 1.5;">- name: Show nginx environment variables
Â  debug:
Â  Â  var: nginx_envs</pre>
Â  Â  </div>


Â  Â  <div style="background: #fff9e6; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #d68910;">Step-by-Step Templating Process:</h4>
Â  Â  Â  <ol style="line-height: 1.8;">
Â  Â  Â  Â  <li><strong>Task starts executing</strong> for a specific host</li>
Â  Â  Â  Â  <li><strong>Ansible needs the value of <code style="background: white; padding: 2px 6px; border-radius: 3px;">nginx_envs</code></strong></li>
Â  Â  Â  Â  <li><strong>Variable Manager is queried</strong> for the host's variables</li>
Â  Â  Â  Â  <li><strong>Jinja2 Template Engine is invoked</strong> with:
Â  Â  Â  Â  Â  <ul style="margin-top: 8px;">
Â  Â  Â  Â  Â  Â  <li>The raw variable value (with literal Jinja2 syntax)</li>
Â  Â  Â  Â  Â  Â  <li>All available variables as context (from inventory, playbook, facts)</li>
Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  </li>
Â  Â  Â  Â  <li><strong>Jinja2 processes the template:</strong>
Â  Â  Â  Â  Â  <ul style="margin-top: 8px;">
Â  Â  Â  Â  Â  Â  <li>Evaluates <code style="background: white; padding: 2px 6px; border-radius: 3px;">{{ expressions }}</code> - variable lookups, filters, etc.</li>
Â  Â  Â  Â  Â  Â  <li>Processes <code style="background: white; padding: 2px 6px; border-radius: 3px;">{% control structures %}</code> - if/else, loops, etc.</li>
Â  Â  Â  Â  Â  Â  <li>Replaces Jinja2 syntax with actual values</li>
Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  </li>
Â  Â  Â  Â  <li><strong>Result is returned</strong> to the task</li>
Â  Â  Â  </ol>
Â  Â  </div>


Â  Â  <div style="background: #e8f4f8; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #2980b9;">Concrete Example:</h4>
Â  Â  Â  <p style="margin: 5px 0;"><strong>Variable in inventory (from Stage 4):</strong></p>
Â  Â  Â  <pre style="background: #2c3e50; color: #ecf0f1; padding: 12px; border-radius: 4px; overflow-x: auto;">"nginx_envs": {
Â  "CSP_HEADER": "{{ csp_policy }}"
},
"csp_policy": "default-src 'self';"</pre>
Â  Â  Â  <p style="margin: 15px 0 5px 0;"><strong>After Jinja2 templating:</strong></p>
Â  Â  Â  <pre style="background: #2c3e50; color: #ecf0f1; padding: 12px; border-radius: 4px; overflow-x: auto;">"nginx_envs": {
Â  "CSP_HEADER": "default-src 'self';"
}</pre>
Â  Â  </div>


Â  Â  <div style="background: #d4edda; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 3px solid #28a745;">
Â  Â  Â  <h4 style="margin-top: 0; color: #155724;">âœ… When Templating Happens:</h4>
Â  Â  Â  <ul style="line-height: 1.8;">
Â  Â  Â  Â  <li><strong>Task parameters</strong> - When Ansible evaluates module arguments</li>
Â  Â  Â  Â  <li><strong>Variable access</strong> - When using <code style="background: white; padding: 2px 6px; border-radius: 3px;">{{ variable }}</code> in playbooks</li>
Â  Â  Â  Â  <li><strong>Template module</strong> - When rendering template files</li>
Â  Â  Â  Â  <li><strong>Conditionals</strong> - When evaluating <code style="background: white; padding: 2px 6px; border-radius: 3px;">when:</code> conditions</li>
Â  Â  Â  Â  <li><strong>Loops</strong> - When processing <code style="background: white; padding: 2px 6px; border-radius: 3px;">loop:</code> or <code style="background: white; padding: 2px 6px; border-radius: 3px;">with_*</code> items</li>
Â  Â  Â  </ul>
Â  Â  </div>


Â  Â  <div style="background: #ffebee; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 3px solid #e74c3c;">
Â  Â  Â  <h4 style="margin-top: 0; color: #c62828;">âš ï¸ Templating Limitations:</h4>
Â  Â  Â  <ul style="line-height: 1.8;">
Â  Â  Â  Â  <li><strong>Dictionary keys:</strong> Templating in dictionary keys is inconsistent and depends on context</li>
Â  Â  Â  Â  <li><strong>Early validation:</strong> Some modules validate parameters before templating completes</li>
Â  Â  Â  Â  <li><strong>Recursive depth:</strong> Ansible only templates to a certain depth by default</li>
Â  Â  Â  Â  <li><strong>Order matters:</strong> Variables must exist before they can be referenced</li>
Â  Â  Â  </ul>
Â  Â  </div>
Â  </div>


Â  <!-- Stage 7 -->
Â  <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid #8e44ad;">
Â  Â  <h3 style="color: #8e44ad; margin-top: 0;">Stage 7: Task Execution - Using Templated Values</h3>
Â  Â Â 
Â  Â  <div style="background: #f3e5f5; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #6a1b9a;">What happens:</h4>
Â  Â  Â  <p style="line-height: 1.6;">Once variables are templated, they're passed to Ansible modules for execution:</p>
Â  Â  Â  <ul style="line-height: 1.8;">
Â  Â  Â  Â  <li><strong>Docker/Kubernetes modules</strong> receive environment variables</li>
Â  Â  Â  Â  <li><strong>Template module</strong> renders configuration files</li>
Â  Â  Â  Â  <li><strong>Shell/command modules</strong> receive templated commands</li>
Â  Â  Â  Â  <li><strong>File modules</strong> receive templated paths and content</li>
Â  Â  Â  </ul>
Â  Â  </div>


Â  Â  <div style="background: #e8f4f8; padding: 15px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <h4 style="margin-top: 0; color: #2980b9;">Example - Container Deployment:</h4>
Â  Â  Â  <pre style="background: #2c3e50; color: #ecf0f1; padding: 12px; border-radius: 4px; overflow-x: auto; line-height: 1.5;">- name: Deploy container
Â  kubernetes.core.k8s:
Â  Â  definition:
Â  Â  Â  kind: Deployment
Â  Â  Â  spec:
Â  Â  Â  Â  template:
Â  Â  Â  Â  Â  spec:
Â  Â  Â  Â  Â  Â  containers:
Â  Â  Â  Â  Â  Â  Â  - name: app
Â  Â  Â  Â  Â  Â  Â  Â  env: "{{ nginx_envs | dict2items }}"</pre>
Â  Â  Â  <p style="margin: 10px 0 0 0; line-height: 1.6;">At this point, <code style="background: white; padding: 2px 6px; border-radius: 3px;">nginx_envs</code> has been fully templated and contains real values, not Jinja2 syntax.</p>
Â  Â  </div>
Â  </div>


Â  <!-- Summary -->
Â  <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; margin: 30px 0; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
Â  Â  <h2 style="margin-top: 0;">ğŸ¯ Pipeline Summary</h2>
Â  Â  <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 5px; margin: 15px 0;">
Â  Â  Â  <ol style="line-height: 2; font-size: 16px;">
Â  Â  Â  Â  <li><strong>YAML Files</strong> â†’ Raw text with Jinja2 syntax (no processing)</li>
Â  Â  Â  Â  <li><strong>Python YAML Parser</strong> â†’ Converts to Python objects (Jinja2 still literal strings)</li>
Â  Â  Â  Â  <li><strong>Inventory Construction</strong> â†’ Merges configs, builds hierarchy (still literal)</li>
Â  Â  Â  Â  <li><strong>JSON Serialization</strong> â†’ Exports to stdout (still literal)</li>
Â  Â  Â  Â  <li><strong>Ansible Loads Inventory</strong> â†’ Stores variables (still literal)</li>
Â  Â  Â  Â  <li><strong>Playbook Execution</strong> â†’ <span style="background: rgba(46, 204, 113, 0.3); padding: 2px 8px; border-radius: 3px;">âœ¨ Jinja2 processing happens HERE âœ¨</span></li>
Â  Â  Â  Â  <li><strong>Task Execution</strong> â†’ Uses fully templated, real values</li>
Â  Â  Â  </ol>
Â  Â  </div>
Â  </div>


Â  <!-- Key Insights -->
Â  <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
Â  Â  <h2 style="color: #2c3e50; margin-top: 0;">ğŸ’¡ Key Insights</h2>
Â  Â Â 
Â  Â  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
Â  Â  Â  <div style="background: #e8f8f5; padding: 15px; border-radius: 5px; border-left: 3px solid #1abc9c;">
Â  Â  Â  Â  <h4 style="margin-top: 0; color: #16a085;">Separation of Concerns</h4>
Â  Â  Â  Â  <p style="margin: 0; line-height: 1.6; font-size: 14px;">YAML parsing and Jinja2 templating are completely separate processes that happen at different times in the pipeline.</p>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  </div></div></div></div>
</div>
</div>
<!--## playbook-run-errors #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-playbook-run-errors">
<h2 class="foldable-title" id="foldable-title-playbook-run-errors">playbook-run-errors</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('playbook-run-errors')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-Ansible','editable-paragraph-playbook-run-errors', 'foldable-content-penButton-playbook-run-errors')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<button class="create-subdiv" id="create-subdiv-playbook-run-errors" onclick="add_subdiv('editable-paragraph-playbook-run-errors')" type='*button"'>
<svg class="add-tag-icon" fill="none" height="22" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
<!-- < and > symbols -->
<path d="M6 8l-4 4 4 4"></path> <!-- Left angle bracket -->
<path d="M18 8l4 4-4 4"></path> <!-- Right angle bracket -->
<!-- Plus sign in center -->
<path d="M12 10v4"></path>
<path d="M10 12h4"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-playbook-run-errors">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-playbook-run-errors" onclick="save_editable_content('Tocco-Ansible','editable-paragraph-playbook-run-errors', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-playbook-run-errors"><pre></pre>

<div class="foldable-container" id="foldcontainer-409-api-error">
<h2 class="foldable-title" id="foldable-title-409-api-error">409-api-error</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('409-api-error')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-Ansible','editable-paragraph-409-api-error', 'foldable-content-penButton-409-api-error')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-409-api-error">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-409-api-error" onclick="save_editable_content('Tocco-Ansible','editable-paragraph-409-api-error', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-409-api-error"><html><head></head><body><pre># 409 api error # 409 openshift error

<strong style="color: red">Error</strong>:
<pre><code class="lang-yaml">
TASK [tocco : set/replace environment variables (nice)] *************************************************************************************
fatal: [abctest]: FAILED! =&gt;Â 
Â  Â  changed: false
Â  Â  msg: 'Failed to replace object: b''{"kind":"Status","apiVersion":"v1","metadata":{},"status":"Failure","message":"Operation
Â  Â  Â  Â  cannot be fulfilled on deploymentconfigs.apps.openshift.io \\"nice\\": the object
Â  Â  Â  Â  has been modified; please apply your changes to the latest version and try again","reason":"Conflict","details":{"name":"nice","group":"apps.openshift.io","kind":"deploymentconfigs"},"code":409}\n'''
Â  Â  reason: Conflict

</code></pre>

<b> Why this happens:</b> it's just how the API works. If you fetch the config, modify it,
and update it and something else updated it, it'll fail.


<strong style="color: green">Fix</strong>: None really, except maybe add retrying mechanism... else just manually retry
</pre></body></html></div>
</div>
</div>
</div>
</div>
</div>
</body></html><!--## 409-api-error #################################################################################################################-->