<!DOCTYPE html>
<html><head>
<title data-folder-path="/Tocco">Tocco-S3</title>
<link href=" ../../static/style.css" rel="stylesheet"/>
<link href="../../prism/prism.css" rel="stylesheet"/>
</head>
<body class="body">
<div class="page-folder-header-div">
<h1 class="pagetitle" data-folder-path="Tocco">Tocco-S3</h1>
<a href="./../..">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M3 11L12 4L21 11"></path>
<path d="M5 10V20H19V10"></path>
<path d="M10 20V14H14V20"></path>
</svg>
</a>
</div>
<!-- Sidebar -->
<div class="sidbear-enclosure-open" id="sidbear-enclosure-open-Tocco-S3">
<button class="sidbear-enclosure-button-open" id="sidbear-enclosure-button-Tocco-S3" onclick="toggle_sidebar()" type="button">
<svg fill="white" height="30" viewBox="0 0 100 80" width="30" xmlns="http://www.w3.org/2000/svg">
<rect height="10" width="100"></rect>
<rect height="10" width="100" y="30"></rect>
<rect height="10" width="100" y="60"></rect>
</svg>
</button>
<div class="sidebar-mainbox-open" id="sidebar-mainbox-Tocco-S3">
<div class="sidebar-subbox-open" id="sidebar-subbox-1" onclick=" append_foldable_content()">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="10"></circle>
<line x1="12" x2="12" y1="8" y2="16"></line>
<line x1="8" x2="16" y1="12" y2="12"></line>
</svg>
</div>
<div class="sidebar-subbox-open" id="sidebar-subbox-2">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="10"></circle>
<path d="M9.09 9C9.32591 8.33109 9.78918 7.76807 10.4 7.41421C11.0108 7.06036 11.7266 6.93913 12.4152 7.07107C13.1038 7.20302 13.7206 7.57857 14.162 8.12132C14.6034 8.66407 14.8397 9.33984 14.83 10.03C14.83 12 12.5 12.5 12.5 14"></path>
<circle cx="12" cy="17" r="1"></circle>
</svg>
</div>
<div class="sidebar-subbox-open" id="sidebar-subbox-3">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="10"></circle>
<path d="M9.09 9C9.32591 8.33109 9.78918 7.76807 10.4 7.41421C11.0108 7.06036 11.7266 6.93913 12.4152 7.07107C13.1038 7.20302 13.7206 7.57857 14.162 8.12132C14.6034 8.66407 14.8397 9.33984 14.83 10.03C14.83 12 12.5 12.5 12.5 14"></path>
<circle cx="12" cy="17" r="1"></circle>
</svg>
</div>
</div>
</div>
<script src="../../prism/prism.js"></script>
<script src="../../static/script.js"></script>
<!--## Tocco-S3-Infos #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-Tocco-S3-Infos">
<h2 class="foldable-title" id="foldable-title-Tocco-S3-Infos">Tocco-S3-Infos</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('Tocco-S3-Infos')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-S3','editable-paragraph-Tocco-S3-Infos', 'foldable-content-penButton-Tocco-S3-Infos')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<button class="create-subdiv" id="create-subdiv-Tocco-S3-Infos" onclick="add_subdiv('editable-paragraph-Tocco-S3-Infos')" type='*button"'>
<svg class="add-tag-icon" fill="none" height="22" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
<!-- < and > symbols -->
<path d="M6 8l-4 4 4 4"></path> <!-- Left angle bracket -->
<path d="M18 8l4 4-4 4"></path> <!-- Right angle bracket -->
<!-- Plus sign in center -->
<path d="M12 10v4"></path>
<path d="M10 12h4"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-Tocco-S3-Infos">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-Tocco-S3-Infos" onclick="save_editable_content('Tocco-S3','editable-paragraph-Tocco-S3-Infos', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-Tocco-S3-Infos"><pre><h3>Tool for s3-management</h3>(pege-selfmade): <b>Tocco S3</b>
<a href="https://toccoag.gitlab.io/tocco-s3/tocco_s3/index.html">Dokumentation</a>


<h3>Official s3-access tool</h3>: <b>s3cmd</b>
s3cmd --help
( config for s3cmd is located at  <i>~/.s3cfg</i> )


<h3>Get Infos about s3-users</h3> <b>tco</b>: 
<pre><code class="lang-bash">tco s3 show-user dev-dain</code></pre>

</pre></div>
</div>
</div>
<!--## S3-Errors #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-S3-Errors">
<h2 class="foldable-title" id="foldable-title-S3-Errors">S3-Errors</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('S3-Errors')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-S3','editable-paragraph-S3-Errors', 'foldable-content-penButton-S3-Errors')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<button class="create-subdiv" id="create-subdiv-S3-Errors" onclick="add_subdiv('editable-paragraph-S3-Errors')" type='*button"'>
<svg class="add-tag-icon" fill="none" height="22" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
<!-- < and > symbols -->
<path d="M6 8l-4 4 4 4"></path> <!-- Left angle bracket -->
<path d="M18 8l4 4-4 4"></path> <!-- Right angle bracket -->
<!-- Plus sign in center -->
<path d="M12 10v4"></path>
<path d="M10 12h4"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-S3-Errors">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-S3-Errors" onclick="save_editable_content('Tocco-S3','editable-paragraph-S3-Errors', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-S3-Errors"><pre><h2 class="highlighteryellow"> 403: SignatureDoesNotMatch </h2>
Beim ausführen von: <pre><code class="lang-bash">s3cmd ls s3://memory-dumps/nice-swissengineering/</code></pre>

<div class="frame">s3cmd ls s3://memory-dumps/nice-swissengineering/
WARNING: Could not refresh role
WARNING: Could not refresh role
ERROR: S3 error: 403 (SignatureDoesNotMatch)
</div>

<span class="highlighterred">Problem</span> / <span class="highlightergreen">Lösung</span>
In <i>~/.s3cfg</i> War der Eintrag für secret_key =
ausversehen bei access_token = gesetzt

Die Credentials, die dort rein gehören kann man mit:
<pre><code class="lang-bash">tco s3 show-user dev-$USERKÜRZEL</code></pre> Anzeigen lassen
</pre></div>
</div>
</div>
<!--## S3-Storage-Design #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-S3-Storage-Design">
<h2 class="foldable-title" id="foldable-title-S3-Storage-Design">S3-Storage-Design</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('S3-Storage-Design')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-S3','editable-paragraph-S3-Storage-Design', 'foldable-content-penButton-S3-Storage-Design')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<button class="create-subdiv" id="create-subdiv-S3-Storage-Design" onclick="add_subdiv('editable-paragraph-S3-Storage-Design')" type='*button"'>
<svg class="add-tag-icon" fill="none" height="22" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
<!-- < and > symbols -->
<path d="M6 8l-4 4 4 4"></path> <!-- Left angle bracket -->
<path d="M18 8l4 4-4 4"></path> <!-- Right angle bracket -->
<!-- Plus sign in center -->
<path d="M12 10v4"></path>
<path d="M10 12h4"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-S3-Storage-Design">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-S3-Storage-Design" onclick="save_editable_content('Tocco-S3','editable-paragraph-S3-Storage-Design', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-S3-Storage-Design"><div class="content"><br/>
<b class="highlighteryellow">Setup</b><br/><br/>
<ul style="margin-left: 20px;">
<li>
                    S3 storage is used for the tocco installations Object-Storage<br/>
                    (Objects such as documents, images, videos that are uploaded or<br/>
                    generated in the Tocco ERP)
      </li><br/>
<li>
                    There is <span class="highlighterblue">one bucket per customer</span>. Production, test system as<br/>
                    well as when developing locally, the <span class="highlighterblue">same bucket</span> is used.
      </li><br/>
<li>
                    Configuration is done via the <span class="highlighterblue">s3.properties file</span> Ansible and S3 API<br/>
                    All <span class="highlighterblue2">buckets</span> are <span class="highlighterblue">created by Ansible</span>. There should be no need to change<br/>
                    the configuration manually.
      </li><br/><br/>
</ul>
<b class="highlighteryellow">Objekte Entfernen / Aufbewahren</b><br/><br/>
<ul style="margin-left: 20px;">
<li>
                  Die Objekte werden mittels Referenzzählung dedupliziert. Sobald der<br/>
                  Referenzzähler Null erreicht, wird das Objekt zum Entfernen markiert.<br/>
                  Das <span class="highlighterblue">Objekt selbst</span> und der <span class="highlighterblue">Verweis</span> in der Tabelle <span class="highlighterorange">_nice_binary</span> werden<br/>
                  jedoch <span class="highlighterblue">nicht sofort entfernt.</span><br/><br/>


                  Dies aus mehreren Gründen:<br/><br/>
<ul>
<li>Das Entfernen von S3-Objekten ist <span class="highlighterblue">langsam</span>. Eine synchrone<br/> Durchführung
                      würde zu <span class="highlighterblue">Verzögerungen</span> führen.
        </li><br/>
<li>Falls ein Backup der Datenbank wiederhergestellt werden muss, ist es<br/>
<span class="highlighterblue">nicht notwendig</span>, auch ein Backup der Objekte wiederherzustellen.</li><br/>
<li>
                      Es gibt <span class="highlighterblue">keine Möglichkeit</span>, atomare und damit <span class="highlighterblue">konsistente</span> Backups zu<br/>
                      erstellen, d. h. Backups, bei denen gewährleistet ist, dass die<br/>
                      Datenbank und der S3-Speicher <span class="highlighterblue">denselben Satz</span> von Objekten enthalten.
        </li><br/>
<li>
<span class="highlighterblue2">Buckets</span> werden von allen Installationen eines Kunden gemeinsam<br/>
                      genutzt, und es gibt keine zuverlässige Methode, um festzustellen, ob<br/>
                      ein Objekt noch von einer anderen Installation verwendet wird.
        </li><br/>
<li>
                      Objekte können nicht atomar als Teil einer DB-Transaktion entfernt<br/>
                      werden. Objekte müssen entfernt werden, <span class="highlighterblue">nachdem</span> ihre Entfernung in<br/>
                      die DB übertragen wurde.
        </li>
<br/>
</ul>
<b class="highlighteryellow">Zugriff / Berechtigungen</b><br/><br/>
<img alt="Code expl3." height="400" src="./../../images/s3_acces.png" width="700"/><br/><br/>
<ul>
<span class="highlighteryellow">Developers Access</span><br/><br/>
<ul>
<li>
                    Jeder Entwickler hat ein Konto, das <span class="highlightergreen">Lese- und Schreibzugriff</span> auf die<br/>
<span class="highlighterblue">Buckets</span> aller Kunden ermöglicht.
      </li><br/>
<li>
                    Developers cannot <span class="highlighterred2">remove</span> any objects or <span class="highlighterred2">change permissions</span>.
      </li>
</ul><br/>
<span class="highlighteryellow">Installation User</span><br/><br/>
<ul>
<li>
                    Jeder Kunde hat einen eigenen Benutzer, dessen Zugang auf seinen<br/>
                    jeweiligen Bucket beschränkt ist.
      </li><br/>
<li>
                    Installationen eines Kunden, ob Produktion oder Test,verwendet<br/>
                    diesen einen Bucket
      </li>
</ul><br/>
<li>
                  Die Berechtigungen werden über eine S3-Policy erteilt.<br/>Die Policy selbst wird von Ansible festgelegt
    </li><br/>
<li>
                  Die Credentials können in <span class="highlighterorange">s3.[local.]properties</span> konfiguriert werden.<br/>
                  Sollten in diesen Dateien keine Anmeldedaten gefunden werden, werden<br/>
                  die Anmeldedaten aus dem Abschnitt <span class="highlighterorange">[nice2]</span> in <span class="highlighterorange">~/.aws/credentials</span><br/>
                  verwendet.
    </li><br/>
<img alt="Code expl3." height="900" src="./../../images/s3_policy.png" width="600"/><br/><br/>
</ul>
</li></ul></div></div>
</div>
</div>
<!--## S3-Objektentfernung #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-S3-Objektentfernung">
<h2 class="foldable-title" id="foldable-title-S3-Objektentfernung">S3-Objektentfernung</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('S3-Objektentfernung')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-S3','editable-paragraph-S3-Objektentfernung', 'foldable-content-penButton-S3-Objektentfernung')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<button class="create-subdiv" id="create-subdiv-S3-Objektentfernung" onclick="add_subdiv('editable-paragraph-S3-Objektentfernung')" type='*button"'>
<svg class="add-tag-icon" fill="none" height="22" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
<!-- < and > symbols -->
<path d="M6 8l-4 4 4 4"></path> <!-- Left angle bracket -->
<path d="M18 8l4 4-4 4"></path> <!-- Right angle bracket -->
<!-- Plus sign in center -->
<path d="M12 10v4"></path>
<path d="M10 12h4"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-S3-Objektentfernung">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-S3-Objektentfernung" onclick="save_editable_content('Tocco-S3','editable-paragraph-S3-Objektentfernung', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-S3-Objektentfernung"><div class="content"><br/>
<p>
<b class="highlighterblue">Terminologie</b><br/><br/>
<b class="highlighteryellow">_nice_binary</b>
</p><ul>
<li>
Datenbanktabelle in Nice zur Verfolgung von Objekten. Alle Objekte<br/>
in Nice werden in dieser Tabelle erfasst.
</li><br/>
</ul><br/>
<b class="highlighteryellow">Dead object</b>
<ul>
<li>
Ein Objekt gilt als tot, wenn es in Nice entfernt wurde (=<br/>
<span class="highlighterorange">_nice_binary.reference_count == 0</span>). In S3 kann es jedoch noch<br/>
vorhanden sein.
</li><br/>
</ul><br/>
<b class="highlighteryellow">Live object</b>
<ul>
<li>
Ein Objekt gilt als "live", solange es noch in einer Produktions-<br/>
oder Testinstallation von Nice verwendet wird (=<br/>
<span class="highlighterorange">_nice_binary.reference_count != 0)</span>.
</li><br/>
</ul><br/>
<b class="highlighteryellow">N days</b>
<ul>
<li>
Zeit zwischen der Entfernung eines Objekts aus allen zu einem Bucket<br/>
gehörenden Installationen und seiner Entfernung in S3.
</li><br/>
</ul><br/>
<b class="highlighteryellow">State DB</b>
<ul>
<li>
DB, die verwendet wird, um festzustellen, wann ein Objekt zuletzt von<br/>
einer Installation verwendet wurde.
</li><br/>
</ul>
<br/><br/>
<div class="frame">
<strong class="highlighterred">Warning</strong><br/>
<span class="highlighterblue">Reference_count</span> ist nicht völlig zuverlässig und kann Null erreichen,<br/>
während noch aktive Referenzen vorhanden sind. Verlassen Sie sich<br/>
nicht auf den Zähler, um festzustellen, ob ein Objekt noch verwendet<br/>
wird<br/><br/>

Erst wenn ein Objekt aus <span class="highlighterblue">_nice_binary</span> entfernt wurde, sollten Sie<br/>
darauf vertrauen, dass es nicht mehr verwendet wird (in der<br/>
entsprechenden DB). Es gibt Fremdschlüssel-Beschränkungen, die<br/>
verhindern, dass eine Zeile in <span class="highlighterblue">nice_binary</span> entfernt wird, solange es<br/>
noch aktive Referenzen gibt.

</div><br/><br/>
<b class="highlighteryellow">Notes</b><br/><br/>
<ul style="margin-left: 20px;">
<li>
Nice markiert Objekte als entfernt, indem es beim Entfernen einen<br/>
<span class="highlighterorange">_nice_binary.removed_at</span> Zeitstempel setzt. Dieser Zeitstempel sollte<br/>
das Entfernen von Objekten erleichtern. Im aktuellen design wird<br/>
dieser Zeitstempel jedoch nicht verwendet, da ...<br/><br/>
<b>a</b>: unser Backup-Tool<br/>
<span class="highlighterorange">_nice_binary-Zeilen</span> auf remote Servern entfernen müsste<br/><br/>
<b>b</b>: wir immer noch einen vollständigen S3-Scan benötigen, um alle Objekte<br/>
zu finden
</li><br/>
<li>
Das Entfernen von Objekten in den Nice-DBs würde eine Menge<br/>
Komplexität hinzufügen, da zusätzliche Daten verfolgt werden müssten.<br/>
Wir müssten nämlich verfolgen, zu welchen Servern und DBs (Plural)<br/>
ein Objekt gehört. Außerdem wäre eine sichere Methode zum Entfernen<br/>
von Objekten in der DB erforderlich.
</li>
</ul><br/><br/>
<h2 class="highlighteryellow">Objektentfernung</h2><br/>
<ul>
<li>
Bei der Entscheidung, ob ein Objekt beibehalten wird, werden nur<br/>
<span class="highlighterblue">Installationen</span> berücksichtigt. Genauer gesagt, werden nur DBs<br/>
auf den Produktions- und Staging-Clustern berücksichtigt. Andere<br/>
Benutzer, die diese Objekte verwenden, werden nicht berücksichtigt.<br/><br/>

Um zu vermeiden, dass Objekte entfernen werden, die andere Nutzer noch benützen<br/>
, wird eine <span class="highlighterblue">Verzögerung</span> von N Tagen zwischen der Entfernung eines Objekts in<br/>
Nice und der Entfernung auf S3 eingefügt. Siehe Grafik unten.<br/><br/>

Auf diese Weise wird sichergestellt, dass ein S3-Objekt, das zu einem<br/>
DB-Backup, einer Entwicklungsdatenbank oder einer anderswo<br/>
gespeicherten DB gehört, <span class="highlighterblue">N Tage lang verfügbar bleibt</span>.<br/><br/>

Es gibt im Wesentlichen <span class="highlighterblue">vier Kategorien</span> von Benutzern, die auf<br/>
einen Bucket zugreifen:
</li><br/>
<ul>
<li>
Installations: Mindestens ein Produktiv- und ein Testsystem benötigen Zugang.
</li>
<li>
Entwickler: Die Entwickler müssen in der Lage sein, Tocco lokal mit einer Kopie<br/>
von prod, test oder einer Wiederherstellung aus einer Sicherungskopie<br/>
auszuführen.


</li>
<li>
Backups: Unser Backuptool muss in der Lage sein, alle Objekte aus<br/>
einem Bucket zu synchronisieren und Objekte zu entfernen.<br/><br/>


Mirroring in einen anderen Bucket ist derzeit nicht<br/>
implementiert, wird aber hier als zukünftige Option aufgeführt. Ein<br/>
Mirroring müsste auch removals synchronisieren (möglicherweise<br/>
mit einer gewissen Verzögerung).
</li>
<li>Restores: : Für eine restore ist der Zugriff auf einen Bucket erforderlich</li>
</ul><br/>
<li>
Wenn es darum geht, das <span class="highlighteryellow">vorzeitige Entfernen</span> von Objekten zu<br/>
vermeiden, muss man Datenbank-Backups und -Wiederherstellungen<br/>
besondere Aufmerksamkeit widmen. Um die Wiederherstellung zu<br/>
erleichtern, wird ein S3-Objekt so lange aufbewahrt, wie die<br/>
Möglichkeit besteht, dass es in einer DB-Sicherung referenziert wird<br/>
(zuzüglich einer gewissen Sicherheitsspanne). Dies wird an anderen<br/>
Stellen mit N Tagen angegeben
</li><br/>
<li>
Wenn wir sicherstellen wollen, dass S3-Objekte nicht aus dem Backup<br/>
wiederhergestellt werden müssen, wenn eine DB wiederhergestellt wird,<br/>
müssen wir für eine ausreichende Verzögerung sorgen, bevor wir ein<br/>
Objekt aus S3 entfernen:
</li><br/>
<b class="highlighteryellow">Serverliste</b><br/><br/>
<ul>
<li>
Objekte können auf verschiedenen serverns verwendet werden.<br/>

Unser Backupttool muss wissen, welche DB-Server existieren, um<br/>
eine Liste der verwendeten Objekte von <b>jedem Server</b> abrufen zu<br/>
können. Die Liste der Server wird über Ansible auf der Grundlage der<br/>
in <span class="highlighterorange">config.yml</span> konfigurierten Server aktualisiert.
</li><br/>
<li>
Es ist wichtig, dass alle DB-Server gescannt werden. Dies ist<br/>
besonders wichtig, wenn ein <span class="highlighterblue">neuer Server hinzugefügt</span> wird. Wenn ein<br/>
Server übersprungen wird, werden Objekte, die nur auf diesem Rechner<br/>
referenziert werden, als nicht referenziert betrachtet und<br/>
schließlich entfernt<br/><br/>


Um sicherzustellen, dass dies rechtzeitig bemerkt wird, wird ein<br/>
neuer Endpunkt hinzugefügt, um die Liste der konfigurierten Server abzurufen:<br/><br/>
<pre><code class="lang-bash"> $ ssh ${S3_BACKUP_SERVER} tocco-s3 list-servers

db1.prod.tocco.cust.vsh.net
db1.stage.tocco.cust.vsh.net
</code></pre>
<b class="highlighteryellow">Notes</b><br/>
<ul>
<li>
<b>Current Implementation</b>: DB-Server werden in der config.toml konfiguriert, die von Ansible generiert wird<br/>
See :<span class="highlighterorange">ansible-repo</span>:`Ansible role s3backup &lt;roles/s3backup/&gt;`
</li><br/>
</ul>
</li><br/>
<li>
<span class="highlighterorange">command=</span> Option in :man:`authorized_keys(5)` wird verwendet, um den<br/>
Befehl an den Verbindungsschlüssel zu binden und nur die Ausführung<br/>
des einen angegebenen Befehls zu erlauben.<br/><br/>


Bei jedem Eingriff in eine Installation, einschließlich der<br/>
Erstellung oder Änderung einer Installation, stellt Ansible eine<br/>
Verbindung zum Endpunkt her und überprüft, ob der derzeit für die<br/>
Installation konfigurierte Server in der vom Endpunkt zurückgegebenen<br/>
Servergruppe enthalten ist. Wenn dies nicht der Fall ist, bricht<br/>
Ansible mit einer Fehlermeldung ab.
</li>
</ul><br/><br/>
<b class="highlighteryellow">Objektliste</b><br/><br/>
<ul>
<li>
Eine Liste der Live-Objekte wird über ssh von jedem DB-Server geholt:<br/>
<pre><code class="lang-bash">ssh $DB_SERVER nice2_list_live_objects</code></pre>


Zurückgegeben wird eine Liste von Hashes; Hashes sind hexadezimal<br/>
kodiert, Kleinbuchstaben gefolgt von ',' und dem Namen der<br/>
entsprechenden DB. Pro Zeile wird ein Objekt zurückgegeben:<br/><br/>
<pre><code class="lang-bash">
72ce10090d03......19b52af2ee,nice_sbk
ca45c2de6d54.......01fb50a,nice_bbg
a9a361f131b5........e8,nice_bbg
</code></pre>

The same hash may be included in the list multiple times
</li><br/>
<li>
Objekte mit einer <span class="highlighterorange">_nice_binary.reference_count</span> von Null<br/>
werden so behandelt, als ob sie nicht existierten.` Die Zählung von<br/>
Referenzen kann ungenau sein und in der Vergangenheit haben<br/>
verschiedene Objekte eine <span class="highlighterorange">reference_count</span> von Null erreicht, während<br/>
sie noch referenziert wurden. Daher werden alle Objekte<br/>
berücksichtigt, auch solche mit einer Referenzanzahl von Null.<br/>
Fremdschlüssel-Beschränkungen verhindern, dass ein referenziertes<br/>
Objekt / eine Tabellenzeile entfernt wird. Daher ist das Fehlen einer<br/>
Zeile ein zuverlässiger Indikator dafür, dass ein Objekt in einer<br/>
Datenbank nicht verwendet wird.
</li><br/>
<li>
Zurückgegebene Hashes sollten auf ihre Gültigkeit als SHA2-Hashes<br/>
überprüft werden, und ungültige Hashes sollten mit einem <br/>
hard error zurückgewiesen werden.<br/><br/>

Der Datenbankname wird später nicht mehr<br/>
verwendet, außer um bessere Diagnosemeldungen zu drucken.<br/><br/>

Die Option<br/> <span class="highlighterorange">command=</span> in :man:`authorized_keys(5)` wird verwendet,<br/>
um den Befehl an den connecting key zu binden und nur die Ausführung des<br/>
einen angegebenen Befehls zuzulassen.<br/><br/>

Jede Datenbank, die eine <span class="highlighterorange">_nice_binary-Tabelle</span> enthält, wird nach Objekten durchsucht
</li><br/>
<b class="highlighteryellow">Wichtig</b><br/>
<ul>
<li>
Es ist von entscheidender Bedeutung, dass keine Objekte entfernt<br/>
werden, wenn das Abrufen von aktiven Objekten von einem Server<br/>
fehlschlägt. Eine Fortsetzung könnte bedeuten, dass einige Objekte<br/>
nicht korrekt als alive erfasst werden.<br/><br/>

Mit der Option<br/>
--created-before &lt;ISO_8601_TIMESTAMP&gt; können die zurückgegebenen<br/>
Objekte auf Objekte beschränkt werden, die vor dem angegebenen ISO<br/>
8601-Zeitstempel erstellt wurden. Siehe Integritätsprüfungen.
</li><br/>
<li>
Die Spalte created_at kann NULL-Werte enthalten. Stellen Sie sicher,<br/>
dass --created-before Zeilen zurückgibt, in denen created_at NULL<br/>
ist.
</li><br/>
<li>
Der Client, der den SSH-Endpunkt aufruft, gilt als nicht<br/>
vertrauenswürdig, und beim Parsen der übergebenen Parameter ist<br/>
Vorsicht geboten.
</li>
</ul><br/><br/>
<b class="highlighteryellow">Liveobjekte tracken</b><br/>
<ul>
<li>
Um zu verfolgen, welche Objekte in Nice entfernt wurden, werden die<br/>
folgenden Metadaten über jedes Objekt in einer state DB<br/>
gespeichert:<br/><br/>
<ul>
<li>Bucket: Bucketname</li><br/>
<li>hash: SHA2 hash eines Objekts</li>
<li>last seen: Zeitangabe, wann das Objekt zuletzt gesehen wurde.</li>
</ul><br/>
</li><br/>
<li>
Die Objekte werden <span class="highlighterblue">global und nicht pro Bucket</span> verfolgt. Dadurch wird<br/>
die Komplexität reduziert. Die Verfolgung pro Bucket würde die<br/>
Komplexität stark erhöhen, da eine DB mit ihrem Bucket verknüpft<br/>
werden müsste. Diese Informationen sind derzeit nur in<br/>
unvollständiger Form in der <span class="highlighterorange">config.yml</span> von Ansible vorhanden<br/><br/>


Objekte werden gelöscht, wenn N Tage seit dem Zeitstempel für das<br/>
letzte Mal gesehen vergangen sind oder, anders ausgedrückt, wenn ein<br/>
Objekt seit N Tagen in Nice entfernt/dead ist.
</li><br/>
<b class="highlighteryellow">Warning</b><br/>
<li>The current design does not handle a the following race condition:<br/><br/>:
<ul style="margin-left:30px;">
<li> An object is removed in Nice.</li>
<li> Scans indicate object has been removed and is dead </li>
<li> N days pass. </li>
<li> Scan still indicating object is (still) dead </li>
<li> Object gets recreated </li>
<li> Object gets removed in S3 </li>
</ul>
</li><br/>
<li>
Es gibt keine einfache Möglichkeit, dieses race zu vermeiden, aber<br/>
es ist unwahrscheinlich, dass es in einem realen Szenario passiert,<br/>
und die Integritätsprüfungen werden es erkennen.<br/><br/>
</li><br/>
<li>
Zuletzt gesehen wird aktualisiert, wenn ein Objekt als alive beobachtet<br/>
wird. Ein Objekt gilt als lebendig, wenn:<br/><br/>
<ul>
<li>
Es noch in einer Nice-DB existiert (siehe Liste der Objekte), .
</li><br/>
<li>es im S3-Bucket erstellt wurde (d. h. wenn es in S3, aber noch nicht in<br/>
der State-DB existiert)</li>
</ul>
</li>
</ul><br/><br/>
<b class="highlighteryellow">Notes</b><br/>
<ul>
<li>
Durch das zusätzliche Scannen der S3-Buckets wird sichergestellt,<br/>
dass Objekte beobachtet werden, die bei einem DB-Scan nicht erkannt<br/>
werden können. Dies kann passieren, wenn<br/><br/>

a: ein Objekt entfernt wird<br/>
(oder die gesamte DB gelöscht wird), bevor ein Objekt bei einem<br/>
DB-Scan beobachtet wird, und<br/><br/>

b: Wenn ein Objekt während der lokalen<br/>
Entwicklung erstellt wird.
</li><br/>
<li>
Auch wenn es nicht notwendig ist, während der Entwicklung erstellte<br/>
Objekte zu sichern, ist es dennoch wünschenswert, sie zu verfolgen,<br/>
um sicherzustellen, dass sie wieder entfernt werden können.<br/><br/>


Es gibt potenziell Millionen von Objekten. Es muss darauf geachtet<br/>
werden, dass die Speichernutzung auf einem vernünftigen Niveau<br/>
gehalten wird, aber die Suchvorgänge für Hashes sind immer noch<br/>
schnell.
</li><br/>
<li>
Objekte in S3, deren Schlüssel kein gültiger sha2-Hash ist, wie von <br/>
Nice kodiert, werden ignoriert.
</li>
</ul><br/><br/>
<b class="highlighteryellow">Effektives Entfernen</b><br/>
<ul>
<li>
Beim Entfernen von Objekten ist es wichtig, dass die state-DB<br/>
aktuell ist. Das heißt, dass es eine erfolgreiche und vollständige<br/>
Aktualisierung der Zustands-DB gab
</li><br/>
<span class="highlighteryellow">Recover from Accidental Removal</span><br/>
<ul>
<li>
Alle Objekte in S3 werden mit der Festplatte auf<br/>
s3backup2.tocco.cust.vshn.net synchronisiert und über Burp<br/>
archiviert. Wenn ein Objekt in S3 entfernt wird, werden auch die<br/>
Backups auf der Festplatte entfernt. Burp-Archive (burp -a list)<br/>
können verwendet werden, um solche Objekte für weitere ~5 Wochen<br/>
wiederherzustellen.
</li>
</ul><br/>
<span class="highlighteryellow">Aktuelle Implementierung</span><br/>
<ul>
<li>
Implementiert in <span class="highlighterblue">tocco-s3</span> als <span class="highlighterblue">tocco-s3 prune</span>.Um die Aktualität der<br/>
State DB zu gewährleisten, wird der Zeitstempel der letzten<br/>
erfolgreichen Aktualisierung in der State DB gespeichert:<br/><br/>
<div class="codebox"><pre> $ sudo -u s3backup sqlite3 /var/lib/s3backup/state.sqlite
sqlite&gt; select * from key_value where key = 'last_db_scan';
last_db_scan|2023-09-14 07:27:15
</pre><button class="copyBtn"></button></div><br/><br/>


last_db_scan ist der Zeitpunkt, an dem die DBs zum letzten Mal<br/>
erfolgreich gescannt wurden und die Zeitstempel für die zuletzt<br/>
gesehenen Objekte aktualisiert wurden. tocco-s3 weigert sich, Objekte<br/>
zu entfernen, wenn der letzte erfolgreiche Scan mehr als 8 Tage<br/>
zurückliegt, um zu verhindern, dass Objekte aufgrund eines veralteten<br/>
DB-Status entfernt werden.
</li>
</ul><br/><br/>
<span class="highlighteryellow">Integrity Checks</span><br/>
<span>
Abschnitt fehlt noch nachtragen aus <a href="https://gitlab.com/toccoag/tocco-docs/-/blob/505e9cf1a95b594de543e8c9f9abe2d632ff5a58/devops/s3/object_removal.rst">LINK</a>
</span>
</ul>
</ul>
</ul>
</div></div>
</div>
</div>
<!--## S3-Backups #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-S3-Backups">
<h2 class="foldable-title" id="foldable-title-S3-Backups">S3-Backups</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('S3-Backups')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-S3','editable-paragraph-S3-Backups', 'foldable-content-penButton-S3-Backups')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<button class="create-subdiv" id="create-subdiv-S3-Backups" onclick="add_subdiv('editable-paragraph-S3-Backups')" type='*button"'>
<svg class="add-tag-icon" fill="none" height="22" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
<!-- < and > symbols -->
<path d="M6 8l-4 4 4 4"></path> <!-- Left angle bracket -->
<path d="M18 8l4 4-4 4"></path> <!-- Right angle bracket -->
<!-- Plus sign in center -->
<path d="M12 10v4"></path>
<path d="M10 12h4"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-S3-Backups">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-S3-Backups" onclick="save_editable_content('Tocco-S3','editable-paragraph-S3-Backups', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-S3-Backups"><pre>Random Q/A

- Theoretisch wenn kunden File A , B wollen (vor 10tagen gelöscht) aber auch in der
zwischenzeit C, D, E gelöscht haben, diese aber nicht brauchen nur A, B
..
einfach alles wiederherstellen, C,D,E sollten dann irgendwann auch gelöscht werden
wenn, nirgends in DBs vorhanden. (problem wenn auch nur auf irgend einer DB, evtl. auch
lokal auf Dev-Pc , gilt dies schon nicht mehr)

</pre>
<div class="foldable-container" id="foldcontainer-systemd-timer-services-manual-start">
<h2 class="foldable-title" id="foldable-title-systemd-timer-services-manual-start">systemd-timer-services-manual-start</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('systemd-timer-services-manual-start')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-S3','editable-paragraph-systemd-timer-services-manual-start', 'foldable-content-penButton-systemd-timer-services-manual-start')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-systemd-timer-services-manual-start">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-systemd-timer-services-manual-start" onclick="save_editable_content('Tocco-S3','editable-paragraph-systemd-timer-services-manual-start', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-systemd-timer-services-manual-start"><pre>s3Backup can also be started manually if the auto-backup fails.
This is for the reason that the alerting does not alert all day long and
of course also that a backup is available at all.

- ssh into s3Backup server

<h3>Timers</h3>

- list timers: <pre><code class="lang-bash">systemctl list-timers</code></pre>
  look for <b>tocco-s3-backup.timer</b>

<h3>Services</h3>

- Search for the service: <pre><code class="lang-bash">systemctl status tocco-s3-backup.service</code></pre>

- Restart the service state: <pre><code class="lang-bash">systemctl start tocco-s3-backup.service</code></pre>

<b>Load</b> : If backups get startet manually, load goes up on server:
-&gt; yes, but should not be a problem
</pre></div>
</div>
</div>
<!--## s3-restore-single-file-example #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-s3-restore-single-file-example">
<h2 class="foldable-title" id="foldable-title-s3-restore-single-file-example">s3-restore-single-file-example</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('s3-restore-single-file-example')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-S3','editable-paragraph-s3-restore-single-file-example', 'foldable-content-penButton-s3-restore-single-file-example')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-s3-restore-single-file-example">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-s3-restore-single-file-example" onclick="save_editable_content('Tocco-S3','editable-paragraph-s3-restore-single-file-example', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-s3-restore-single-file-example"><div class="content">
<ul>
<li>
Auf s3backup2 sind verschiedene systemd-timer eingerichtet, welche<br/>
unter anderem die backup Dienste überwachen / timen.


Diese können mit systemctl list-timers angezeigt werden,so finden<br/>
wir die folgenden 2:<br/>
<pre><code class="lang-bash">
tocco-s3-backup-validation.timer tocco-s3-backup-validation.service<br/>
tocco-s3-backup.timer tocco-s3-backup.service<br/>
</code></pre>


Die können irgendwie hilfreich sein, beim suchen nach fehlenden files...
</li><br/>
<li>
Backups werden grundsätzlich so erstellt, dass wir einfach auf den<br/>
s3backup2 server gehen. Dort das gewünschte Archiv aufsuchen und das<br/>
dort einfügen, was wir auf S3 selbst gerne gerestored hätten.


<ul>
<li>
dazu wie im test-fall mit pege . Auf den Server gehen:
</li><br/>
<li>
cd in archiv-location: <span class="highlighteryellow">cd /var/lib/s3backup</span>
</li><br/>
<li>
Ein File erstellen : <span class="highlighteryellow"> head -c 50 /dev/urandom &gt; test_file</span>
</li><br/>
<li>
File hashen (s3 ist so configuriert,dass es nicht erlaubt<br/>
“ungehashte” files in ein buckt zu hinterlegen) : <span class="highlighteryellow">sha256sum test_file</span>
</li><br/>
<li>
Testfile auf erhaltenen hash moven : <span class="highlighteryellow">mv test_file 3fbekj2lhjr…….</span>
</li><br/>
<li>
Gehashtes Test-file in den entrsprechenden bucket-archive ordner in <br/>
/var/lib/s3backup/tocco-nice-$NAME moven:<span class="highlighteryellow"> mv 3fbekj2lhjr... tocco-nice-test</span>
</li>
</ul>
</li><br/>
<li>
Nun haben wir das gewünschte File, ordnungsgemäss ins Archiv<br/>
hinzugefügt. Als nächstes führen wir mit dem tocco-s3 Tool einfach<br/>
einen Restore auf den entsprechenden S3-Bucket durch, dann wird<br/>
erkennt, dass Archiv und S3-Bucket nicht gleich sind und das geaddete<br/>
File ( oder die geaddeten Objekte wen mehrere) werden zum S3-Bucket<br/>
hinzugefügt.
</li><br/>
<ul>
<li>
Ins Archiv verzeichnis wechseln (so können wir den command mit<br/>
einem einfachen “.“ für <span class="highlighterred">&lt;DIRECTORY&gt;</span><br/>
ausführen) : cd /var/lib/s3backup/
</li><br/>
<li>
restore command durchführen, dabei ist wichtig es muss ein<br/>
<span class="highlighteryellow">&lt;MODE&gt;</span> mitgegeben werden:


<div class="frame">
tocco-s3 restore [OPTIONS] <span class="highlighterred">&lt;DIRECTORY&gt;</span> <span class="highlighteryellow">&lt;MODE&gt;</span> [BUCKETS]…
z.b.<br/>
</div><br/>
<pre><code class="lang-bash">
<pre> tocco-s3 restore <span class="highlighterred">.</span> hash-only nice-tocco-tests
</pre>
<button class="copyBtn"></button>
</code></pre>
</li>
</ul><br/>
<li>
Dokumente die länger als 1 halbes Jahr nicht verwendet werden,<br/>
sollten erkannt und irgendwan dann entfernt werden.
</li>
</ul>
<div class="frame">
Restore modes:

hash-only:<br/>
Limits restore to hash objects. Objects that already<br/>
exist on S3 are ignored. Because the key on S3 is<br/>
the hash over the content, the content can never change.

all-if-missing:<br/>
Restores all objects, hash and non-hash objects. Objects<br/>
that already exist on S3 are ignored.

Possible values:<br/>
- hash-only:Restore hash objects only<br/>
- all-if-missing: Restore hash and non-hash objects if missing


Dokument dann auf S3-Finden ….<br/>
<b>$ s3cmd ls s3://tocco-nice-test | grep e1e670baaa056e73bedef3f4cc50eb22c8b94c7cb528263ef08a4db9809d67db</b>
</div>
</div></div>
</div>
</div>

<div class="foldable-container" id="foldcontainer-S3-Restore-Commands">
<h2 class="foldable-title" id="foldable-title-S3-Restore-Commands">S3-Restore-Commands</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('S3-Restore-Commands')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Tocco-S3','editable-paragraph-S3-Restore-Commands', 'foldable-content-penButton-S3-Restore-Commands')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-S3-Restore-Commands">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-S3-Restore-Commands" onclick="save_editable_content('Tocco-S3','editable-paragraph-S3-Restore-Commands', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-S3-Restore-Commands"><html><head></head><body><pre>- Backups are stored on <b>s3backup2.tocco.cust.vshn.net</b> at <i>var/lib/s3backup/</i>.

<pre><code class="lang-bash">
$ ssh s3backup2.tocco.cust.vshn.net
$ ls /var/lib/s3backup/
tocco-nice-agogistest
tocco-nice-anavant
tocco-nice-anavanttest
…
tocco-nice-zgp
tocco-nice-zgptest
</code></pre>
</pre>

- Every <i>directory</i> represents a bucket of the same name and contains the
objects belonging to a bucket where the path equals the key used
in S3:(so executing <b>ls</b> inside one of those folders prints a million lines...)

<pre><code class="lang-bash">ls /var/lib/s3backup/tocco-nice-bk/
0002a5205c33ac64bb7242d8cb3e289986a15f2fb009c92e55df4756ca2236ea
0002a520234sdfsfsdfs242d8cb3e234234215f2fb009c555525df4756ca2236ea
.
.
</code></pre>


<h2 class="highlighteryellow">Restoring to S3</h2>
- A bucket can be restored like this:
<pre><code class="lang-bash">sudo -u s3backup tocco-s3 restore /var/lib/s3backup hash-only ${BUCKET}</code></pre>

- To restore the objects to Lupfig (second location of Cloudcsale)
   adjust the endpoint URL in /var/lib/s3backup/config.toml:
<pre><code class="lang-bash">

- To restore objects entirely different S3 storage, you can specify a key per bucket in <i>/var/lib/s3backup/config.toml</i>:
[s3] endpoint = "https://objects.lpg.cloudscale.ch"</code></pre>/var/lib/s3backup/config.toml:

<pre><code class="lang-bash">
[s3]
[s3.keys.bucket1]
access_key = "..."
secret_key = "..."

[s3.keys.bucket2]
access_key = "..."
secret_key = "..." </code></pre>

See tocco-s3 restore --help for available options.


<h2 class="highlighteryellow">BTRFS Snapshots</h2>

Daily BTRFS snapshots are available at /var/lib/s3backup-snapshots.
These go back 30 days.

Use <b>cp -reflink=always</b> when copying anything out of the snapshots to
ensure the CoW functionality of BTRFS is used when copying. Linux
before 5.18, does not support -reflink across mount points. Instead,
mount the root subvolume and do the copying there:

<pre><code class="lang-bash">
mkdir /mnt/tmp
mount /dev/sdb /mnt/tmp
cd /mnt/tmp
cp --reflink=always @s3backup-snapshot/${path} @s3backup/${path}
</code></pre>
See also BTRFS tutorial in tocco docs.


<h2 class="highlighteryellow">Backups Archive - Burp and Borg</h2>
- Backups located at <i>/var/lib/s3backup/</i> are additionally backed up
daily to a remote server. This backups can be accessed using <b>Burp</b>.


<pre><code class="lang-bash">
ssh s3backup2.tocco.cust.vshn.net
$ burp -Q -a list
Backup: 0000008 2019-12-09 22:02:23 +0100 (deletable)
Backup: 0000015 2019-12-16 22:01:17 +0100 (deletable)
Backup: 0000022 2019-12-23 22:06:20 +0100 (deletable)
Backup: 0000029 2019-12-30 22:02:21 +0100 (deletable)
Backup: 0000033 2020-01-03 22:05:59 +0100 (deletable)
Backup: 0000034 2020-01-04 22:07:11 +0100 (deletable)
Backup: 0000035 2020-01-05 22:13:08 +0100 (deletable)
Backup: 0000036 2020-01-06 22:02:07 +0100 (deletable)
Backup: 0000037 2020-01-07 22:08:46 +0100 (deletable)
Backup: 0000038 2020-01-08 22:13:57 +0100 (deletable)
Backup: 0000039 2020-01-09 22:05:07 +0100 (deletable)
</code></pre>


- List content of backup 0000035:


<pre><code class="lang-bash">
$ ssh s3backup2.tocco.cust.vshn.net
$ burp -Q -a list -b 0000035
…
/var/lib/s3backup/tocco-nice-bk/0002a5205c33ac64bb7242d8cb3e289986a15f2fb009c92e55df4756ca2236ea
/var/lib/s3backup/tocco-nice-bk/001f5cf0d7894b5ed9975ed1871434916dac32c4a7b26237db6f0848019b1eb0
/var/lib/s3backup/tocco-nice-bk/002d5df593b5cd88fb536ead3f82cc95e661e059b0fe079ab3e2089c9d4db973
…
/var/lib/s3backup/tocco-nice-bk/fff72c0ef03bb21fa3d8d94e0d977ff007137784c8dcd3e23928ef88463f618d
/var/lib/s3backup/tocco-nice-bk/fff774f50d7a4751a73da766dab141bc7a8ee6b2f0c3c6416a51a7a05ee9ad46
…
</code></pre>


- Restore bucket tocco-nice-bk from backup 0000035:


<pre><code class="lang-bash">
$ ssh s3backup2.tocco.cust.vshn.net
$ mkdir /var/lib/s3backup/restore
$ cd /var/lib/s3backup/restore
$ burp -Q -a restore -b 0000035 -d . -r '^/var/lib/s3backup/tocco-nice-bk/'
$ ls var/lib/s3backup/tocco-nice-bk/
/var/lib/s3backup/tocco-nice-bk/0002a5205c33ac64bb7242d8cb3e289986a15f2fb009c92e55df4756ca2236ea
/var/lib/s3backup/tocco-nice-bk/001f5cf0d7894b5ed9975ed1871434916dac32c4a7b26237db6f0848019b1eb0
/var/lib/s3backup/tocco-nice-bk/002d5df593b5cd88fb536ead3f82cc95e661e059b0fe079ab3e2089c9d4db973
…
/var/lib/s3backup/tocco-nice-bk/fff72c0ef03bb21fa3d8d94e0d977ff007137784c8dcd3e23928ef88463f618d
/var/lib/s3backup/tocco-nice-bk/fff774f50d7a4751a73da766dab141bc7a8ee6b2f0c3c6416a51a7a05ee9ad46
</code></pre>

<h2 class="highlighteryellow">Backup from Archive - Burp</h2>
- Restore backup to S3:
<pre><code class="lang-bash">
$ cp /var/lib/s3backup/config.toml .
$ sudo -u s3backup tocco-s3 restore /var/lib/s3backup hash-only tocco-nice-bk
</code></pre>

- Independend backup archives are also created via Borg.
<div class="frame">
Use borg-2 instead of borg to use secondary <b>Borg backup</b>. See also Borg Backup in docs
</div>

- List archives:

<pre><code class="lang-bash">
$ ssh s3backup2.tocco.cust.vshn.net sudo -i borg list
</code></pre>
- List archive content:
<pre><code class="lang-bash">
 $ ssh s3backup2.tocco.cust.vshn.net sudo -i borg list ::s3-2024-04-23T06:21:0
</code></pre>

- Restore files:

<pre><code class="lang-bash">
$ ssh -t s3backup2.tocco.cust.vshn.net sudo -i
$ mkdir /var/lib/s3backup/restore
$ cd /var/lib/s3backup/restore
$ borg extract ::s3-2024-04-23T06:21:02 var/lib/s3backup/tocco-nice-bis
</code></pre>


<h2 class="highlighteryellow">Other commands</h2>
- List files eines Buckets:
<pre><code class="lang-bash">$ s3cmd ls s3://tocco-nice-test</code></pre>


- Irgend ein File lokal nach /home/dave/s3_test runterladen:
<pre><code class="lang-bash">$ s3cmd get s3://tocco-nice-test/fffdej2..... /home/dave/s3_test</code></pre>




</body></html></div>
</div>
</div>
</div>
</div>
</div>
</body></html><!--## S3-Restore-Commands #################################################################################################################--><!--## systemd-timer-services-manual-start #################################################################################################################-->