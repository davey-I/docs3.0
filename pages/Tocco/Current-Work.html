<!DOCTYPE html>
<html><head>
<title data-folder-path="/Tocco">Current-Work</title>
<link href=" ../../static/style.css" rel="stylesheet"/>
<link href="../../prism/prism.css" rel="stylesheet"/>
</head>
<body class="body">
<div class="page-folder-header-div">
<h1 class="pagetitle" data-folder-path="Tocco">Current-Work</h1>
<a href="./../..">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M3 11L12 4L21 11"></path>
<path d="M5 10V20H19V10"></path>
<path d="M10 20V14H14V20"></path>
</svg>
</a>
</div>
<!-- Sidebar -->
<div class="sidbear-enclosure-open" id="sidbear-enclosure-open-Current-Work">
<button class="sidbear-enclosure-button-open" id="sidbear-enclosure-button-Current-Work" onclick="toggle_sidebar()" type="button">
<svg fill="white" height="30" viewBox="0 0 100 80" width="30" xmlns="http://www.w3.org/2000/svg">
<rect height="10" width="100"></rect>
<rect height="10" width="100" y="30"></rect>
<rect height="10" width="100" y="60"></rect>
</svg>
</button>
<div class="sidebar-mainbox-open" id="sidebar-mainbox-Current-Work">
<div class="sidebar-subbox-open" id="sidebar-subbox-1" onclick=" append_foldable_content()">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="10"></circle>
<line x1="12" x2="12" y1="8" y2="16"></line>
<line x1="8" x2="16" y1="12" y2="12"></line>
</svg>
</div>
<div class="sidebar-subbox-open" id="sidebar-subbox-2">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="10"></circle>
<path d="M9.09 9C9.32591 8.33109 9.78918 7.76807 10.4 7.41421C11.0108 7.06036 11.7266 6.93913 12.4152 7.07107C13.1038 7.20302 13.7206 7.57857 14.162 8.12132C14.6034 8.66407 14.8397 9.33984 14.83 10.03C14.83 12 12.5 12.5 12.5 14"></path>
<circle cx="12" cy="17" r="1"></circle>
</svg>
</div>
<div class="sidebar-subbox-open" id="sidebar-subbox-3">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="10"></circle>
<path d="M9.09 9C9.32591 8.33109 9.78918 7.76807 10.4 7.41421C11.0108 7.06036 11.7266 6.93913 12.4152 7.07107C13.1038 7.20302 13.7206 7.57857 14.162 8.12132C14.6034 8.66407 14.8397 9.33984 14.83 10.03C14.83 12 12.5 12.5 12.5 14"></path>
<circle cx="12" cy="17" r="1"></circle>
</svg>
</div>
</div>
</div>
<script src="../../prism/prism.js"></script>
<script src="../../static/script.js"></script>
<!--## WAF #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-WAF">
<h2 class="foldable-title" id="foldable-title-WAF">WAF</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('WAF')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Current-Work','editable-paragraph-WAF', 'foldable-content-penButton-WAF')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<button class="create-subdiv" id="create-subdiv-WAF" onclick="add_subdiv('editable-paragraph-WAF')" type='*button"'>
<svg class="add-tag-icon" fill="none" height="22" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
<!-- < and > symbols -->
<path d="M6 8l-4 4 4 4"></path> <!-- Left angle bracket -->
<path d="M18 8l4 4-4 4"></path> <!-- Right angle bracket -->
<!-- Plus sign in center -->
<path d="M12 10v4"></path>
<path d="M10 12h4"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-WAF">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-WAF" onclick="save_editable_content('Current-Work','editable-paragraph-WAF', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-WAF"><div class="foldable-container" id="foldcontainer-run-apache-on-PINP-env">
<h2 class="foldable-title" id="foldable-title-run-apache-on-PINP-env">run-apache-on-PINP-env</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('run-apache-on-PINP-env')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Current-Work','editable-paragraph-run-apache-on-PINP-env', 'foldable-content-penButton-run-apache-on-PINP-env')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-run-apache-on-PINP-env">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-run-apache-on-PINP-env" onclick="save_editable_content('Current-Work','editable-paragraph-run-apache-on-PINP-env', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-run-apache-on-PINP-env"><pre><h2 class="highlighteryellow">Create Dockerfile</h2>
  <b>NOTE</b> : run the first podman container always with <b>--privileged</b>, otherwise fuse-overlay-error

      -  <pre><code class="lang-bash">use apache image FROM docker.io/library/httpd:2.4.65-trixie</code></pre>

<pre><code class="lang-bash">
podman run -dit --name waf-testing --privileged -v waf-testing:/usr/local/my_container 37ec2fea7530
</code></pre>
      -  run the apache2(not the first-container) always with -d, otherwise we get a SIGWINCH error
         but we can start it simply with podman start ${ID}

<pre><code class="lang-bash">
podman run -d --net=host --name apache2 -e APACHE2_HEADER_Some-Header='some "value"' -e APACHE2_ALWAYS_HEADER_Some__Always__Header='some always "value"' tocco-apache2
podman run -d -u 1234:0 --net=host --name apache2 -e APACHE2_HEADER_Some-Header='some "value"' -e APACHE2_ALWAYS_HEADER_Some__Always__Header='some always "value"' tocco-apache2</code></pre>

        Enter the container: <pre><code class="lang-bash">podman exec -it d801fe80d810 bash</code></pre>

     -  Decide if envvar in <i>/etc/apache2/</i> is to keep or not...--
</pre></div>
</div>
</div>
<div class="foldable-container" id="foldcontainer-deploy-to-shared-imagestream">
<h2 class="foldable-title" id="foldable-title-deploy-to-shared-imagestream">deploy-to-shared-imagestream</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('deploy-to-shared-imagestream')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Current-Work','editable-paragraph-deploy-to-shared-imagestream', 'foldable-content-penButton-deploy-to-shared-imagestream')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-deploy-to-shared-imagestream">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-deploy-to-shared-imagestream" onclick="save_editable_content('Current-Work','editable-paragraph-deploy-to-shared-imagestream', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-deploy-to-shared-imagestream"><pre>deploy TO shared-imagestreams


be aware, that the whole thing is setup that new images from shared-imagestreams are only taken
if a projects config has the "nginx_enable_image_change_trigger: true" set...




On Openshift:


   - created new image-stream (oc create is apache2 -n shared-imagestreams) in old Project (shared-imagestreams)


Local
    - Built the image local with description from doc-entrance from below...
    - use 'upload own image' steps from https://docs.tocco.ch/devops/service_setup.html#initial-manual-deployment


    - cd {TO_WHERE_CONTAINERFILE_IS}
    - podman build -t registry.apps.openshift.tocco.ch/shared-imagestreams/apache2:latest .
    - podman login -u any --password-stdin registry.apps.openshift.tocco.ch &lt; &lt;(oc whoami -t)
    - podman push registry.apps.openshift.tocco.ch/shared-imagestreams/apache2:latest


 
Problem DB-Deployment
Hat man die Master-DB aktiv, failed der replication-controller pod irgendwie immer. Deshalb vor deployment kurz wechseln auf "_old":


Old -&gt; Master:


ALTER DATABASE nice_abctest RENAME TO nice_abctest_old;
ALTER DATABASE nice_abctest_history RENAME TO nice_abctest_history_old;


ALTER DATABASE nice_abctest_master RENAME TO nice_abctest;
ALTER DATABASE nice_abctest_history_master RENAME TO nice_abctest_history;




Master -&gt; Old:


ALTER DATABASE nice_abctest RENAME TO nice_abctest_master;
ALTER DATABASE nice_abctest_history RENAME TO nice_abctest_history_master;


ALTER DATABASE nice_abctest_old RENAME TO nice_abctest;
ALTER DATABASE nice_abctest_history_old RENAME TO nice_abctest_history;
</pre></div>
</div>
</div>
<!--## geoIP-restriciton #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-geoIP-restriciton">
<h2 class="foldable-title" id="foldable-title-geoIP-restriciton">geoIP-restriciton</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('geoIP-restriciton')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Current-Work','editable-paragraph-geoIP-restriciton', 'foldable-content-penButton-geoIP-restriciton')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-geoIP-restriciton">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-geoIP-restriciton" onclick="save_editable_content('Current-Work','editable-paragraph-geoIP-restriciton', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-geoIP-restriciton"><pre><h2 class="highlighteryellow">Apply GeoIP restriciton</h2>


Use mod_maxminddb or only mod_security ?
   -&gt; rather split it up into two separate functionalities. Otherwise unwanted traffic would be processed much further
        / cause more unwanted trafficing, security-rule evaluation etc...


<h3>Apply mod_maxminddb</h3>


- Direkt via apt ? - Geht nicht, da apt nur die alte / outdated version von maxminddb zur
   verfügung hat https://github.com/maxmind/geoip-api-mod_geoip2

- Die neue version gibts nicht via apt. Wir müssen also von source selber builden..
   ungefähr so  - soure: https://github.com/maxmind/mod_maxminddb

     # Install dependencies
     apt install apache2-dev libmaxminddb-dev libmaxminddb0 mmdb-bin build-essential wget

     # Download and extract mod_maxminddb
     cd /tmp
     wget https://github.com/maxmind/mod_maxminddb/releases/download/1.3.0/mod_maxminddb-1.3.0.tar.gz
     tar -xzf mod_maxminddb-1.3.0.tar.gz
     cd mod_maxminddb-1.3.0

     # Compile and install
     ./configure
     make
     --------- Since this would require 356 MB space , we better do all the building outside the container --

     make install

     # Load the module
     echo "LoadModule maxminddb_module /usr/lib/apache2/modules/mod_maxminddb.so" &gt; /etc/apache2/mods-available/maxminddb.load
     a2enmod maxminddb

     # Restart Apache
     systemctl restart apache2

- The finished containerfile had the following commands in it:
<pre><code class="lang-bash">

ADD mod_maxminddb.so /usr/lib/apache2/modules/
ADD GeoLite2-Country.mmdb /usr/local/share/
RUN echo "LoadModule maxminddb_module /usr/lib/apache2/modules/mod_maxminddb.so" &gt; /etc/apache2/mods-available/maxminddb.load
a2enmod maxminddb"
</code></pre>

- After the module is setup we need to download the latest maxmindDB (country lite) to some location on inside the container
   shared folder on local machine :   /home/dave/.local/share/containers/storage/volumes/waf-testing/_data/apache-CI
   we need an account for this on maxminddb

- Next we need to configure the module in the main apache2 config with something like this:

       <i>MaxMindDBEnable</i> On
       <i>MaxMindDBFile</i> COUNTRY_DB /usr/local/share/GeoIP/GeoLite2-Country.mmdb
       <i>MaxMindDBEnv</i> COUNTRY_CODE COUNTRY_DB/country/iso_code

- if this all works, we can then define rules to allow coutries -&gt; https://github.com/maxmind/mod_maxminddb?tab=readme-ov-file#allowing-by-country
   this makes probably most sense,  if defined in the nice2.config.template on the location s Directives.</pre></div>
</div>
</div>
<!--## geoIP-restriction-WordPress #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-geoIP-restriction-WordPress">
<h2 class="foldable-title" id="foldable-title-geoIP-restriction-WordPress">geoIP-restriction-WordPress</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('geoIP-restriction-WordPress')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Current-Work','editable-paragraph-geoIP-restriction-WordPress', 'foldable-content-penButton-geoIP-restriction-WordPress')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-geoIP-restriction-WordPress">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-geoIP-restriction-WordPress" onclick="save_editable_content('Current-Work','editable-paragraph-geoIP-restriction-WordPress', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-geoIP-restriction-WordPress"><pre><h2 class="highlighteryellow">Step 1: Install mod_maxminddb (one-time setup)</h2>
Since we need to do this without restarting Apache immediately, we can prepare everything first:
bash# Copy  compiled module and database ( first via <b>scp</b> to home, then on server as root to..)
<pre><code class="lang-bash">
cp mod_maxminddb.so /usr/lib/apache2/modules/
cp GeoLite2-Country.mmdb /usr/local/share/
chmod 644 /usr/lib/apache2/modules/mod_maxminddb.so
</code></pre>

# Create the module load file
<pre><code class="lang-bash">echo "LoadModule maxminddb_module /usr/lib/apache2/modules/mod_maxminddb.so" &gt; /etc/apache2/mods-available/maxminddb.load</code></pre>

# Enable the module (prepares symlink but won't load until restart)
<pre><code class="lang-bash">a2enmod maxminddb

# Enabling module maxminddb.
# To activate the new configuration, you need to run:
  systemctl restart apache2
</code></pre>

<h2 class="highlighteryellow">Step 2: Create a reusable GeoIP include file</h2>
Create <i>/etc/apache2/includes/geoip_restriction.conf</i>:
apache# GeoIP Configuration - Allow only CH, DE, AT (or internal IPs)
<pre><code class="lang-bash">MaxMindDBEnable On
MaxMindDBFile DB /usr/local/share/GeoLite2-Country.mmdb
MaxMindDBEnv MM_COUNTRY_CODE DB/country/iso_code</code></pre>

# Set AllowCountry for allowed countries
<pre><code class="lang-bash">SetEnvIf MM_COUNTRY_CODE ^(CH|DE|AT)$ AllowCountry</code></pre>

# Also allow internal/monitoring IPs
<pre><code class="lang-bash">SetEnvIf Remote_Addr ^172\.18\. AllowCountry
SetEnvIf Remote_Addr ^10\. AllowCountry
SetEnvIf Remote_Addr ^127\. AllowCountry</code></pre>

# Apply restriction
<pre><code class="lang-bash">&lt;RequireAll&gt;
    Require all granted
    Require env AllowCountry
&lt;/RequireAll&gt;</code></pre>

All together:

<pre><code class="lang-bash">
# GeoIP Configuration - Allow only CH, DE, AT (or internal IPs)
MaxMindDBEnable On
MaxMindDBFile DB /usr/local/share/GeoLite2-Country.mmdb
MaxMindDBEnv MM_COUNTRY_CODE DB/country/iso_code
SetEnvIf MM_COUNTRY_CODE ^(CH|DE|AT)$ AllowCountry

# internal/monitoring IPs for monitoring
SetEnvIf Remote_Addr ^172\.18\. AllowCountry
SetEnvIf Remote_Addr ^10\. AllowCountry
SetEnvIf Remote_Addr ^127\. AllowCountry

&lt;requireall&gt;
    Require all granted
    Require env AllowCountry
&lt;/requireall&gt;
</code></pre>

<h2 class="highlighteryellow"> Step 3: Modify your VirtualHost template</h2>
Update Ansible template to include the GeoIP restriction in the HTTPS VirtualHost:
<pre><code class="lang-bash">&lt;VirtualHost *:443&gt;
        ServerName web-page1.test308.tocco.ch
        ServerAlias web-page2.test308.tocco.ch
        AADefaultHatName test308
        DocumentRoot /var/www/vhosts/test308
        CustomLog /var/log/apache2/test308_access.log custom
        ErrorLog /var/log/apache2/test308_error.log
        Include includes/sec_headers.conf
        
        # GeoIP Restriction - protect everything except ACME challenges
        &lt;LocationMatch "^/(?!\.well-known/)"&gt;
            Include includes/geoip_restriction.conf
        &lt;/LocationMatch&gt;
        
        &lt;FilesMatch \.php(\/.*)?$&gt;
                SetHandler "proxy:unix:/var/run/php/test308.sock|fcgi://localhost"
        &lt;/FilesMatch&gt;
        &lt;LocationMatch ^/fpm-status&gt;
                SetHandler "proxy:unix:/var/run/php/test308.sock|fcgi://localhost"
        &lt;/LocationMatch&gt;
        SSLEngine on
        SSLCertificateFile      /etc/letsencrypt/live/wordpress-test308/fullchain.pem
        SSLCertificateKeyFile   /etc/letsencrypt/live/wordpress-test308/privkey.pem
        &lt;Files xmlrpc.php&gt;
            Require all denied
        &lt;/Files&gt;
&lt;/VirtualHost&gt;</code></pre>

<h2 class="highlighteryellow"> Step 4: Deployment Strategy (minimize downtime)</h2>
For a production deployment with minimal disruption:
bash# 1. Test configuration syntax WITHOUT restarting
<pre><code class="lang-bash">apachectl configtest</code></pre>

# 2. If syntax is OK, schedule a graceful restart during low-traffic period
# Graceful restart finishes existing requests before reloading 
# (probably not enough, since its a complete new module..)
<pre><code class="lang-bash">systemctl reload apache2</code></pre>

<div class="frame">
We can test if the module is already loaded (<b>reload</b> is enough)
with:

<pre><code class="lang-bash">apachectl -M | grep maxminddb
# positive if we get a "maxminddb_module (shared)"
</code></pre>
</div>

# OR if it needs full restart (for the module load):
# Plan a brief maintenance window and notify customers
<pre><code class="lang-bash">systemctl restart apache2</code></pre>

Alternative: Per-customer control
If some customers need different country restrictions, create parameterized includes:
<pre><code class="lang-bash">/etc/apache2/includes/geoip_restriction_default.conf (CH, DE, AT)
/etc/apache2/includes/geoip_restriction_eu.conf (all EU countries)
/etc/apache2/includes/geoip_restriction_global.conf (no restrictions)</code></pre>
Then in your Ansible variables, set which include each customer uses.

<h3>Important Notes:</h3>

ACME challenges -  LocationMatch "^/(?!\.well-known/)" already excludes .well-known, which is perfect for Let's Encrypt renewals
Testing - Test on one low-traffic vhost first before rolling out to all customers
Monitoring - Watch  error logs after deployment for unexpected 403s
Communication - If any customers have legitimate users outside CH/DE/AT, coordinate first

</pre></div>
</div>
</div>

<!--## apply-apache2-waf #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-apply-apache2-waf">
<h2 class="foldable-title" id="foldable-title-apply-apache2-waf">apply-apache2-waf</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('apply-apache2-waf')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Current-Work','editable-paragraph-apply-apache2-waf', 'foldable-content-penButton-apply-apache2-waf')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-apply-apache2-waf">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-apply-apache2-waf" onclick="save_editable_content('Current-Work','editable-paragraph-apply-apache2-waf', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-apply-apache2-waf"><html><head></head><body><pre><h2 class="highlighteryellow">Actual WAF implementation steps </h2>
<h3>Add</h3> apt-get installation for to <i>libapache2-mod-security2</i> to <b>Containerfile</b>:
<pre><code class="lang-bash">
RUN apt-get update \
    &amp;&amp; apt-get install -y --no-install-recommends python3 python3-jinja2 apache2 libmaxminddb0 libapache2-mod-security2 \
</code></pre>

<h3>Add</h3> the predefined config file modsecurity.conf:
<pre><code class="lang-bash">
ADD modsecurity.conf /etc/modsecurity/
</code></pre>
To actually enable the config, we need to change <b>SecRuleEngine DetectionOnly</b>
to <b>SecRuleEngine On</b>

<h3>Other directives worth mentioning:</h3>
- <b>SecResponseBodyAccess</b> (default <i>On</i>): configures whether response bodies are buffered (i.e. read by modsecurity)
    neccessary if data leakage detection and protection is required. Leavinc it on will increase the logfile size.

- <b>SecRequestBodyLimit</b>: specifies the maximum POST data size. If anything larger is sent by a client the server
    will respond with a <strong>413: Request Entity Too Large</strong> If your web application doesn’t have any file
    uploads this value can be greatly reduced. (Tocco does have a file-upload but maybe an option..?)

    For ex. can be set to: <pre><code class="lang-bash">SecRequestBodyLimit 13107200</code></pre> which is <i>12.5MB</i>.


- There is also the <b>SecRequestBodyNoFilesLimit 131072</b> and the <b>SecRequestBodyInMemoryLimit 131072</b>

Additional infos about testing and the config <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-mod_security-with-apache-on-debian-ubuntu">Here</a><br/>

<h3>Create</h3> modsec_audit.log in correct location:
<pre><code class="lang-bash">
&amp;&amp; touch /var/log/modsec_audit.log
</code></pre>
Not sure, but the file would otherwise just be added in <i>/var/log/apache2/</i>
but it would still search for it at <i>/var/log/</i>

<h3>Change</h3> group and mod:
<pre><code class="lang-bash">
&amp;&amp; chgrp -R 0 /var/log/modsec_audit.log \
&amp;&amp; chmod -R g+rwx /var/log/modsec_audit.log
</code></pre>
</pre></body></html></div>
</div>
</div>
</div>
</div>
</div>
</body></html><!--## deploy-to-shared-imagestream #################################################################################################################--><!--## run-apache-on-PINP-env #################################################################################################################--><!--## Apache-Approach #################################################################################################################-->