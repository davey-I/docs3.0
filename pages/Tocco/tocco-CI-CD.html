<!DOCTYPE html>
<html><head>
<title data-folder-path="/Tocco">tocco-CI-CD</title>
<link href=" ../../static/style.css" rel="stylesheet"/>
<link href="../../prism/prism.css" rel="stylesheet"/>
</head>
<body class="body">
<div class="page-folder-header-div">
<h1 class="pagetitle" data-folder-path="Tocco">tocco-CI-CD</h1>
<a href="./../..">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M3 11L12 4L21 11"></path>
<path d="M5 10V20H19V10"></path>
<path d="M10 20V14H14V20"></path>
</svg>
</a>
</div>
<!-- Sidebar -->
<div class="sidbear-enclosure-open" id="sidbear-enclosure-open-tocco-CI-CD">
<button class="sidbear-enclosure-button-open" id="sidbear-enclosure-button-tocco-CI-CD" onclick="toggle_sidebar()" type="button">
<svg fill="white" height="30" viewBox="0 0 100 80" width="30" xmlns="http://www.w3.org/2000/svg">
<rect height="10" width="100"></rect>
<rect height="10" width="100" y="30"></rect>
<rect height="10" width="100" y="60"></rect>
</svg>
</button>
<div class="sidebar-mainbox-open" id="sidebar-mainbox-tocco-CI-CD">
<div class="sidebar-subbox-open" id="sidebar-subbox-1" onclick=" append_foldable_content()">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="10"></circle>
<line x1="12" x2="12" y1="8" y2="16"></line>
<line x1="8" x2="16" y1="12" y2="12"></line>
</svg>
</div>
<div class="sidebar-subbox-open" id="sidebar-subbox-2">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="10"></circle>
<path d="M9.09 9C9.32591 8.33109 9.78918 7.76807 10.4 7.41421C11.0108 7.06036 11.7266 6.93913 12.4152 7.07107C13.1038 7.20302 13.7206 7.57857 14.162 8.12132C14.6034 8.66407 14.8397 9.33984 14.83 10.03C14.83 12 12.5 12.5 12.5 14"></path>
<circle cx="12" cy="17" r="1"></circle>
</svg>
</div>
<div class="sidebar-subbox-open" id="sidebar-subbox-3">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="10"></circle>
<path d="M9.09 9C9.32591 8.33109 9.78918 7.76807 10.4 7.41421C11.0108 7.06036 11.7266 6.93913 12.4152 7.07107C13.1038 7.20302 13.7206 7.57857 14.162 8.12132C14.6034 8.66407 14.8397 9.33984 14.83 10.03C14.83 12 12.5 12.5 12.5 14"></path>
<circle cx="12" cy="17" r="1"></circle>
</svg>
</div>
</div>
</div>
<script src="../../prism/prism.js"></script>
<script src="../../static/script.js"></script>
<!--## overview #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-overview">
<h2 class="foldable-title" id="foldable-title-overview">overview</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('overview')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('tocco-CI-CD','editable-paragraph-overview', 'foldable-content-penButton-overview')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<button class="create-subdiv" id="create-subdiv-overview" onclick="add_subdiv('editable-paragraph-overview')" type='*button"'>
<svg class="add-tag-icon" fill="none" height="22" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
<!-- < and > symbols -->
<path d="M6 8l-4 4 4 4"></path> <!-- Left angle bracket -->
<path d="M18 8l4 4-4 4"></path> <!-- Right angle bracket -->
<!-- Plus sign in center -->
<path d="M12 10v4"></path>
<path d="M10 12h4"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-overview">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-overview" onclick="save_editable_content('tocco-CI-CD','editable-paragraph-overview', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-overview"><pre><h3>Deployment vs. Migration</h3>
- Explained <a src="https://docs.tocco.ch/devops/deployment/intro.html">here</a>

- A <i>deployment</i> is an update within the <i>same minor version</i>.
For instance, an update <i>within 3.0.</i> ( Happens in <strong>Stage and Production</strong> )


- <i>stage-deployments</i> result in building a new docker-image, that gets pushed
to Openshift.


- <i>prod-deployments</i> docker-image from stage gets copied and pushed
to Openshift

- A <b>migration</b> is an update across a <b>major or minor</b> version.
For instance, an update from <b>3.0 to 3.1</b>.


- During a <b>migration</b>, an additional <b>testnew</b> system is created and
updated to the desired version.
</pre></div>
</div>
</div>
<!--## gerrit-ci-cd #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-gerrit-ci-cd">
<h2 class="foldable-title" id="foldable-title-gerrit-ci-cd">gerrit-ci-cd</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('gerrit-ci-cd')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('tocco-CI-CD','editable-paragraph-gerrit-ci-cd', 'foldable-content-penButton-gerrit-ci-cd')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<button class="create-subdiv" id="create-subdiv-gerrit-ci-cd" onclick="add_subdiv('editable-paragraph-gerrit-ci-cd')" type='*button"'>
<svg class="add-tag-icon" fill="none" height="22" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
<!-- < and > symbols -->
<path d="M6 8l-4 4 4 4"></path> <!-- Left angle bracket -->
<path d="M18 8l4 4-4 4"></path> <!-- Right angle bracket -->
<!-- Plus sign in center -->
<path d="M12 10v4"></path>
<path d="M10 12h4"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-gerrit-ci-cd">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-gerrit-ci-cd" onclick="save_editable_content('tocco-CI-CD','editable-paragraph-gerrit-ci-cd', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-gerrit-ci-cd"><pre>- Gerrit creates a “Pull request” for every commit made.
if there is <i>one</i> additional commit, it can be added with --amend
if <i>multiple commits</i> <b> git rebase -i </b>

- Every commit must be reviewed by another person, the reviewer
can give a ranking of:
<ul>
<li> -2: Do not submit </li>
<li> -1: I would prefer that you didnt submit this </li>
<li> +1: Looks good to me, but someone else must approve </li>
<li> +2: Looks good to me, approved </li>
</ul>
- A commit needs to have a +2 so that it can be submitted (merged)
It also needs a <b>+1 from the Teamcity verification</b>


- The <b>Teamcity verification (V)</b> starts automatically (as soon as a Teamcity agent is idle).
When the verification returns a -1, the jobs needs to be checked for the cause.
Also if no number or checkmark at all is appearing under <b>(V)</b>.
This is probably a  trigger-problem. (see image below)
<img height="300" src="../../images/gerrit_verification.png" width="100"/>

<div class="frame">- Once a commit has been submitted, <b>additional jobs will be started</b> to merge the changes
into the releases branch and to higher versions (if the changes were made on an older version).
Merging to higher versions can sometimes lead to merge conflicts which then need to be fixed.
</div>
</pre></div>
</div>
</div>
<!--## openshift-nginx #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-openshift-nginx">
<h2 class="foldable-title" id="foldable-title-openshift-nginx">openshift-nginx</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('openshift-nginx')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('tocco-CI-CD','editable-paragraph-openshift-nginx', 'foldable-content-penButton-openshift-nginx')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<button class="create-subdiv" id="create-subdiv-openshift-nginx" onclick="add_subdiv('editable-paragraph-openshift-nginx')" type='*button"'>
<svg class="add-tag-icon" fill="none" height="22" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
<!-- < and > symbols -->
<path d="M6 8l-4 4 4 4"></path> <!-- Left angle bracket -->
<path d="M18 8l4 4-4 4"></path> <!-- Right angle bracket -->
<!-- Plus sign in center -->
<path d="M12 10v4"></path>
<path d="M10 12h4"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-openshift-nginx">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-openshift-nginx" onclick="save_editable_content('tocco-CI-CD','editable-paragraph-openshift-nginx', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-openshift-nginx"><h2>How does the CI/CD Pipeline for the Tocco Nginx Webserver work ?</h2>
<div class="foldable-container" id="foldcontainer-1.Pipeline-Trigger-gitlab-ci.yml">
<h2 class="foldable-title" id="foldable-title-1.Pipeline-Trigger-gitlab-ci.yml">1.Pipeline-Trigger-gitlab-ci.yml</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('1.Pipeline-Trigger-gitlab-ci.yml')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('tocco-CI-CD','editable-paragraph-1.Pipeline-Trigger-gitlab-ci.yml', 'foldable-content-penButton-1.Pipeline-Trigger-gitlab-ci.yml')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-1.Pipeline-Trigger-gitlab-ci.yml">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-1.Pipeline-Trigger-gitlab-ci.yml" onclick="save_editable_content('tocco-CI-CD','editable-paragraph-1.Pipeline-Trigger-gitlab-ci.yml', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-1.Pipeline-Trigger-gitlab-ci.yml"><pre>- Whenever you <b>push to GitLab</b>, the .gitlab-ci.yml defines
<b>what jobs run</b> (build, test, deploy, etc.).



- GitLab runners then pick up those jobs.


<div>
<h1>GitLab CI Pipeline Explanation</h1>

<h4>1. Default Configuration</h4>
- GitLab picks a runner machine that has the "tocxxxoo-podman" tag and loads up
   a special Debian Linux container that already has Podman installed


<pre><code class="lang-yaml">default:
image: registry.gitlab.com/toccoag/base-images/debian:stable-podman</code></pre>
<p>This section defines the <b>default Docker image</b> that will be used
for all jobs in the pipeline unless explicitly overridden. The image
<i>registry.gitlab.com/tocxxxooag/base-images/debian:stable-podman</i>
is a custom Debian-based image from a private GitLab registry that includes
<b>Podman</b> (a Docker alternative) pre-installed. This base image is
specifically designed for container operations in OpenShift environments.</p>

<h4>2. Job Definition - "tests"</h4>
<pre><code class="lang-yaml">tests:</code></pre>
<p>This <b>defines a job named "tests"</b> that will contain all the
testing and validation steps for the Docker image build process.</p>
<h4>3. Runner Tags</h4>
<pre><code class="lang-yaml"> tags:
- tocxxxoo-podman</code></pre>
<p>Specifies that this job should run on GitLab runners that have the
tag <b>tocxxxoo-podman</b>. This ensures the job runs on runners that
are <b>specifically configured</b> with <i>Podman capabilities</i> and the
necessary permissions for container operations in an OpenShift environment.</p>
<h4>4. Script Execution Steps</h4>
<h4>4.1. System Package Updates</h4>
The system updates its software packages and installs Python 3 with the requests
library (needed for making web requests later)
<pre><code class="lang-yaml"> - apt-get update
- apt-get install -y python3 python3-requests</code></pre>
<p>Updates the Debian package lists and installs <b>Python 3</b> along
with the <i>python3-requests</i> library. The requests library is
needed for making HTTP calls during testing, particularly for the
health checks that will follow.</p>
<h4>4.2. Container Image Build</h4>
Podman builds a new Docker image called "tocco-nginx"
<i>using the Dockerfile</i> in your project folder
<pre><code class="lang-yaml"> - podman build -t tocco-nginx .</code></pre>
<p>Builds a container image using <b>Podman</b> (instead of Docker) from
the Dockerfile in the current directory. The image is tagged as <i>tocxxxoo-nginx</i>.
This creates the custom Nginx image that's designed for OpenShift deployment.</p>
<h4>4.3. Container Deployment and Configuration</h4>
The freshly built Nginx image gets started as a running container with special settings:
<pre><code class="lang-yaml"> - |
podman run -d -u 1234:0 --net=host --name nginx -e NGINX_HEADER_Some-Header='some "value"' \
-e NGINX_ALWAYS_HEADER_Some__Always__Header='some always "value"' \
tocxxxoo-nginx</code></pre>
<p>Starts the Nginx container with specific OpenShift-compatible settings:</p>
<ul>
<li><b>-d</b>: Runs the container in detached mode (background)</li>
<li><b>-u 1234:0</b>: Sets user ID to 1234 and group ID to 0, which is
<i>OpenShift's security model</i> for running containers as non-root users</li>
<li><b>--net=host</b>: Uses the host's network stack directly</li>
<li><b>--name nginx</b>: Names the container "nginx" for easy reference</li>
<li><b>Environment variables</b>: Sets custom Nginx headers that will be added to responses:
<ul>
<li><i>NGINX_HEADER_Some-Header</i>: Adds a conditional header</li>
<li><i>NGINX_ALWAYS_HEADER_Some__Always__Header</i>: Adds a header that's always present</li>
</ul>
</li>
</ul>
<h4>4.4. Health Check and Readiness Validation</h4>
The pipeline waits for Nginx to fully start up by repeatedly checking
if it responds properly on port 8081 at the "/status-tocxxxoo-nginx" endpoint.
If it doesn't respond after some time, it shows the container logs and fails
<pre><code class="lang-yaml"> - |
while ! [[ $(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8081/status-tocxxxoo-nginx") = 200 ]]; do
echo "waiting for Nginx to become ready"
podman exec -it nginx true || { podman logs nginx; exit 1; }
sleep 1;
done</code></pre>
<p>Implements a <b>health check loop</b> that waits for Nginx to become fully operational:</p>
<ul>
<li>Makes HTTP requests to <i>http://localhost:8081/status-tocxxxoo-nginx</i> until it returns HTTP 200</li>
<li>If the container becomes unresponsive, it <b>dumps the container logs</b> and exits with error code 1</li>
<li>Sleeps for 1 second between attempts to avoid overwhelming the service</li>
<li>This ensures the container is not just running, but actually <i>serving requests properly</i></li>
</ul>
<h4>4.5. Nginx Configuration Validation</h4>
Once Nginx is running, it tests if the Nginx configuration files are valid by running
<pre><code class="lang-yaml"> - podman exec nginx nginx -t || { podman logs nginx; false; }</code></pre>
<p>Validates the Nginx configuration inside the running container by executing
<b>nginx -t</b>. If the configuration is invalid, it dumps the container logs
and fails the pipeline. This catches any <i>syntax errors or misconfigurations</i>
in the Nginx setup.</p>
<h4>4.6. Unit Test Execution</h4>
<pre><code class="lang-yaml"> - PYTHONPATH=$PWD python3 -m unittest discover tests</code></pre>
<p>Runs Python unit tests using the <b>unittest discovery mechanism</b>. Sets
<i>PYTHONPATH</i> to the current working directory to ensure proper module imports.
This discovers and executes all unit tests in the "tests" directory.</p>
<h4>4.7. Integration Test Execution</h4>
<pre><code class="lang-yaml"> - ./tests/integration_tests.py</code></pre>
<p>Executes the integration test script that likely tests the <b>end-to-end
functionality</b> of the Nginx container, including testing the custom headers,
routing, and other <i>OpenShift-specific features</i>.</p>
<h4>Overall Pipeline Purpose</h4>
<p>This GitLab CI pipeline is designed to build, test, and validate a <b>custom
Nginx Docker image</b> specifically configured for <i>OpenShift deployment</i>.
The pipeline ensures that:</p>
<ul>
<li>The image builds successfully with Podman</li>
<li>The container runs with OpenShift's security constraints (non-root user)</li>
<li>Custom header functionality works as expected</li>
<li>All configuration is valid</li>
<li>Both unit and integration tests pass</li>
</ul>
<p>The use of Podman instead of Docker aligns with OpenShift's container
runtime, and the specific user ID (1234) and networking configuration
ensure <i>compatibility with OpenShift's security policies</i>.</p>
</div>
</pre></div>
</div>
</div>
<!--## 2.Dockerfile #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-2.Dockerfile">
<h2 class="foldable-title" id="foldable-title-2.Dockerfile">2.Dockerfile</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('2.Dockerfile')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('tocco-CI-CD','editable-paragraph-2.Dockerfile', 'foldable-content-penButton-2.Dockerfile')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-2.Dockerfile">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-2.Dockerfile" onclick="save_editable_content('tocco-CI-CD','editable-paragraph-2.Dockerfile', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-2.Dockerfile"><pre><h4>1. Base Image Selection</h4>
<pre><code class="lang-dockerfile">FROM docker.io/library/nginx</code></pre>
<p>Starts with the <b>official Nginx image</b> from Docker Hub as the foundation.
This provides a pre-configured Nginx web server with all basic functionality already set up.</p>

<h4>2. System Dependencies Installation</h4>
<pre><code class="lang-dockerfile">RUN apt-get update \
    &amp;&amp; apt-get install -y --no-install-recommends python3 python3-jinja2 \
    &amp;&amp; rm -r /var/cache/apt/*</code></pre>
<p>Updates the package lists and installs <b>Python 3</b> with the <i>Jinja2 templating library</i>.
 The <b>--no-install-recommends</b> flag keeps the image size smaller by avoiding suggested
packages. After installation, it cleans up the package cache to <i>reduce the final image size</i>.</p>

<h4>3. Configuration Files Deployment</h4>
<pre><code class="lang-dockerfile">ADD nice2.conf.template /etc/nginx/conf.d/
ADD nginx.conf.template /etc/nginx/</code></pre>
<p>Copies <b>Nginx configuration templates</b> into the container. These are
<i>Jinja2 templates</i> that will be processed by Python scripts to generate
the final configuration files with dynamic values.</p>

<h4>4. Python Scripts Installation</h4>
<pre><code class="lang-dockerfile">ADD header_config.py /usr/local/bin/
ADD csp_header_config.py /usr/local/bin/
ADD entrypoint.py /usr/local/bin/</code></pre>
<p>Installs custom Python scripts that handle:</p>
<ul>
    <li><b>header_config.py</b>: Processes HTTP header configuration from environment variables</li>
    <li><b>csp_header_config.py</b>: Handles <i>Content Security Policy</i> header generation</li>
    <li><b>entrypoint.py</b>: Main startup script that coordinates template processing and Nginx startup</li>
</ul>

<h4>5. Security and Static Files</h4>
<pre><code class="lang-dockerfile">ADD security.txt /var/www/.well-known/security.txt
ADD *.include /etc/nginx/</code></pre>
<p>Adds a <b>security.txt file</b> (RFC 9116 compliance for security contact information)
and copies all <i>.include files</i> to the Nginx configuration directory. These include
files likely contain reusable Nginx configuration snippets.</p>

<h4>6. OpenShift Permission Configuration</h4>
<pre><code class="lang-dockerfile">RUN chmod -R 777 /var/log/nginx /var/cache/nginx /var/run \
    &amp;&amp; chgrp -R 0 /etc/nginx \
    &amp;&amp; chmod -R g+rwX /etc/nginx</code></pre>
<p>Critical <b>OpenShift compatibility settings</b>:</p>
<ul>
    <li>Sets <i>777 permissions</i> on log, cache, and run directories so non-root users can write to them</li>
    <li>Changes group ownership to <b>group 0 (root group)</b> for the Nginx config directory</li>
    <li>Gives the root group <i>read, write, and execute permissions</i> on config files</li>
    <li>This allows OpenShift's arbitrary user IDs to function properly</li>
</ul>

<h4>7. Default Configuration Cleanup</h4>
<pre><code class="lang-dockerfile">    &amp;&amp; rm -f /etc/nginx/conf.d/default.conf</code></pre>
<p>Removes the <b>default Nginx configuration</b> to ensure only custom configurations
are active, preventing conflicts with the templated configuration.</p>

<h4>8. Script Permissions and Security.txt Processing</h4>
<pre><code class="lang-dockerfile">    &amp;&amp; chmod +x /usr/local/bin/header_config.py /usr/local/bin/header_config.py /usr/local/bin/entrypoint.py \
    &amp;&amp; : expiry date is required by spec for unknown reasons, so adding it \
    &amp;&amp; sed -i "s/{{ expiry_date }}/$(date -d +180days +%FTT%T.000Z)/g" /var/www/.well-known/security.txt</code></pre>
<p>Makes the Python scripts <b>executable</b> and processes the security.txt template by
replacing the <i>{{ expiry_date }}</i> placeholder with a date 180 days in the future.
The RFC 9116 specification requires an expiry date for security.txt files.</p>

<h4>9. Port Exposure</h4>
<pre><code class="lang-dockerfile">EXPOSE 8081</code></pre>
<p>Documents that the container will listen on <b>port 8081</b> instead of the
standard port 80. This is common in containerized environments where
non-privileged ports are preferred.</p>

<h4>10. Container Startup</h4>
<pre><code class="lang-dockerfile">ENTRYPOINT ["/usr/local/bin/entrypoint.py"]</code></pre>
<p>Sets the <b>entrypoint.py script</b> as the main process that starts when the container
runs. This script will process all the Jinja2 templates with environment variables and then
start Nginx with the generated configuration.</p>

<h4>Overall Dockerfile Purpose</h4>
<p>This Dockerfile creates a <b>highly configurable Nginx container</b> specifically
designed for <i>OpenShift deployment</i>. Key features include:</p>
<ul>
    <li><b>Dynamic configuration</b>: Uses Python and Jinja2 templates to generate
Nginx configs from environment variables</li>
    <li><b>OpenShift security compliance</b>: Proper permissions for non-root execution</li>
    <li><b>Security standards</b>: RFC 9116 compliant security.txt file</li>
    <li><b>Custom header management</b>: Specialized scripts for HTTP header configuration</li>
    <li><b>Template-driven</b>: All configuration can be customized at runtime via
       environment variables</li>
</ul>
</pre></div>
</div>
</div>
<!--## 3.entrypoint-script #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-3.entrypoint-script">
<h2 class="foldable-title" id="foldable-title-3.entrypoint-script">3.entrypoint-script</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('3.entrypoint-script')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('tocco-CI-CD','editable-paragraph-3.entrypoint-script', 'foldable-content-penButton-3.entrypoint-script')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-3.entrypoint-script">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-3.entrypoint-script" onclick="save_editable_content('tocco-CI-CD','editable-paragraph-3.entrypoint-script', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-3.entrypoint-script"><h2>entrypoint.py File Explanation</h2>
<pre><pre><h4>1. Template Processing Function</h4>
<pre><code class="lang-python">def create_nginx_conf():
    process_template(Path('/etc/nginx/nginx.conf.template'))
    for template in Path('/etc/nginx/conf.d/').glob('*.conf.template'):
        process_template(template)</code></pre>
<p>This function orchestrates the <b>configuration file generation</b> process.
It first processes the main <i>nginx.conf.template</i> file, then loops through all
<b>.conf.template</b> files in the <i>/etc/nginx/conf.d/</i> directory and processes
each one. This creates the final Nginx configuration files from the Jinja2 templates.</p>

<h4>3. Main Startup Function</h4>
<pre><code class="lang-python">def main():
    GLOBAL_DIRECTIVES='daemon off;'</code></pre>
<p>Defines the main startup process and sets <b>daemon off</b> directive,
which is crucial for containerized environments. This keeps Nginx running in
the <i>foreground</i> so the container doesn't exit immediately.</p>

<h4>4. Header Configuration Processing</h4>
<pre><code class="lang-python">    subprocess.check_call(['/usr/local/bin/header_config.py'])
    subprocess.check_call(['/usr/local/bin/csp_header_config.py'])</code></pre>
<p>Executes the specialized header configuration scripts:</p>
<ul>
    <li><b>header_config.py</b>: Processes general HTTP header settings from environment variables</li>
    <li><b>csp_header_config.py</b>: Handles <i>Content Security Policy</i> header generation</li>
    <li>Uses <b>subprocess.check_call</b> to ensure both scripts complete successfully or the container startup fails</li>
</ul>

<h4>5. Configuration Generation</h4>
<pre><code class="lang-python">    create_nginx_conf()</code></pre>
<p>Calls the configuration generation function to <b>process all Jinja2 templates</b>
and create the final Nginx configuration files with <i>environment variable substitutions</i>.</p>


<h4>6. Configuration Validation</h4>
<pre><code class="lang-python">    subprocess.check_call(['nginx', '-t', '-g', GLOBAL_DIRECTIVES])</code></pre>
<p>Validates the generated Nginx configuration using <b>nginx -t</b> (test mode). The <i>-g</i>
flag passes the global directive. If the configuration is invalid, the container startup fails immediately,
preventing deployment of broken configurations.</p>


<h4>7. Nginx Startup</h4>
<pre><code class="lang-python">    os.execvp('nginx', ['nginx', '-g', GLOBAL_DIRECTIVES])</code></pre>
<p>Replaces the current Python process with the <b>Nginx process</b> using <i>os.execvp</i>. This ensures:</p>
<ul>
    <li>Nginx becomes the <b>main container process</b> (PID 1)</li>
    <li>Proper signal handling for container shutdown</li>
    <li>The <i>daemon off</i> directive keeps Nginx in foreground mode</li>
    <li>Container lifecycle is tied directly to the Nginx process</li>
</ul>


<h4>8. Script Entry Point</h4>
<pre><code class="lang-python">if __name__ == '__main__':
    main()</code></pre>
<p>Standard Python idiom that ensures the <b>main() function</b> only runs when the script is
 executed directly (not imported). This makes the script the <i>container's entrypoint</i>.</p>


<h4>Overall Entrypoint Purpose</h4>
<p>This entrypoint script serves as a <b>configuration orchestrator</b> for the Nginx container:</p>
<ul>
    <li><b>Dynamic configuration</b>: Generates Nginx configs from templates using environment variables</li>
    <li><b>Header management</b>: Processes custom HTTP headers before starting Nginx</li>
    <li><b>Validation</b>: Ensures configuration is valid before starting the web server</li>
    <li><b>Process management</b>: Properly transitions from setup script to Nginx as the main process</li>
    <li><b>Container compliance</b>: Ensures Nginx runs correctly in containerized environments</li>
</ul>


<p>The script transforms a <i>template-based configuration system</i> into a running Nginx
 instance, making the container highly configurable through environment variables while maintaining
configuration integrity.</p>
</pre>
</pre></div>
</div>
</div>
<!--## 4.header_config-script #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-4.header_config-script">
<h2 class="foldable-title" id="foldable-title-4.header_config-script">4.header_config-script</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('4.header_config-script')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('tocco-CI-CD','editable-paragraph-4.header_config-script', 'foldable-content-penButton-4.header_config-script')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-4.header_config-script">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-4.header_config-script" onclick="save_editable_content('tocco-CI-CD','editable-paragraph-4.header_config-script', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-4.header_config-script"><html><head></head><body><h2>header_config.py explanation</h2>
<pre><h4>Introduction: What are HTTP Headers?</h4>
<p>HTTP headers are <b>metadata fields</b> that web servers send along with web
pages to provide additional information to browsers and clients. They control things
like <i>security policies</i>, <b>caching behavior</b>, <i>content types</i>, and
various browser features. This script allows you to dynamically configure custom
headers through environment variables, making your Nginx container highly flexible
for different deployment scenarios without rebuilding the image.</p>

<h4>1. Environment Variable Prefixes</h4>
<pre><code class="lang-python">ENV_PREFIX = 'NGINX_HEADER_'
ENV_ALWAYS_PREFIX = 'NGINX_ALWAYS_HEADER_'</code></pre>
<p>Defines the <b>prefixes</b> that identify header-related environment variables:</p>
<ul>
    <li><b>NGINX_HEADER_</b>: Creates headers that are added <i>conditionally</i> (only for successful responses)</li>
    <li><b>NGINX_ALWAYS_HEADER_</b>: Creates headers that are <i>always added</i> regardless of response status</li>
</ul>

<h4>2. String Escaping Configuration</h4>
<pre><code class="lang-python">QUOTE_TRANSLATION_TABLE = str.maketrans({
    "\\": r"\\",
    '"':  r'\"'
})</code></pre>
<p>Creates a <b>translation table</b> for safely escaping special characters in header
values. This ensures that <i>backslashes and quotes</i> in header values don't break
the Nginx configuration syntax.</p>

<h4>3. Header Class Definition</h4>
<pre><code class="lang-python">class Header:
    def __init__(self, name, value, *, always):
        self.name = name
        self.value = value
        self.always = always</code></pre>
<p>Defines a <b>Header object</b> that encapsulates:</p>
<ul>
    <li><b>name</b>: The HTTP header name (e.g., "X-Frame-Options")</li>
    <li><b>value</b>: The header value (e.g., "DENY")</li>
    <li><b>always</b>: Boolean flag indicating if the header should always be sent</li>
</ul>

<h4>4. Nginx Configuration Line Generation</h4>
<pre><code class="lang-python">    def line(self):
        param = ' always' if self.always else ''
        return "add_header {} {}{};".format(quote(self.name), quote(self.value), param)</code></pre>
<p>Generates the actual <b>Nginx configuration line</b> for the header. Creates syntax like:</p>
<ul>
    <li><i>add_header "X-Custom-Header" "value";</i> for conditional headers</li>
    <li><i>add_header "X-Custom-Header" "value" always;</i> for always-sent headers</li>
</ul>

<h4>5. Value Quoting Function</h4>
<pre><code class="lang-python">def quote(value):
    return '"' + value.translate(QUOTE_TRANSLATION_TABLE) + '"'</code></pre>
<p>Safely <b>quotes header values</b> for Nginx configuration by:</p>
<ul>
    <li>Wrapping the value in <i>double quotes</i></li>
    <li>Escaping any <b>backslashes or quotes</b> within the value</li>
    <li>Preventing configuration syntax errors</li>
</ul>

<h4>6. Header Name Processing</h4>
<pre><code class="lang-python">def unescape(value):
    return value.replace('__', '-')</code></pre>
<p>Converts <b>double underscores to hyphens</b> in header names. This allows
 environment variable names to represent HTTP headers with hyphens (since environment
variables can't contain hyphens). Example: <i>NGINX_HEADER_X__Frame__Options</i>
becomes <b>X-Frame-Options</b>.</p>

<h4>7. Environment Variable Processing</h4>
<pre><code class="lang-python">def extract_headers(env):
    for key, value in env.items():
        if key.startswith(ENV_PREFIX):
            yield Header(unescape(key[len(ENV_PREFIX):]), value, always=False)
        elif key.startswith(ENV_ALWAYS_PREFIX):
            yield Header(unescape(key[len(ENV_ALWAYS_PREFIX):]), value, always=True)</code></pre>
<p>Scans through <b>all environment variables</b> and:</p>
<ul>
    <li>Finds variables starting with <i>NGINX_HEADER_</i> or <i>NGINX_ALWAYS_HEADER_</i></li>
    <li>Extracts the <b>header name</b> by removing the prefix and converting underscores to hyphens</li>
    <li>Creates <i>Header objects</i> with the appropriate "always" flag</li>
    <li>Uses a <b>generator</b> for memory efficiency</li>
</ul>

<h4>8. Configuration File Generation</h4>
<pre><code class="lang-python">def write_config(stream, headers):
    write = functools.partial(print, file=stream)
    write('# DO NOT EDIT MANUALLY!')
    write('# content is generated based on NGINX_HEADER_* and NGINX_ALWAYS_HEADER_* environment variables')
    write()
    for header in sorted(headers, key=lambda i: i.name):
        write(header.line())</code></pre>
<p>Generates the <b>Nginx include file</b> with:</p>
<ul>
    <li>Warning comments about <i>automatic generation</i></li>
    <li>Headers <b>sorted alphabetically</b> by name for consistency</li>
    <li>Each header converted to its <i>Nginx configuration line</i></li>
</ul>

<h4>9. Main Execution Function</h4>
<pre><code class="lang-python">def main(env, path):
    headers = extract_headers(env)
    with open(path, 'w') as f:
        write_config(f, headers)</code></pre>
<p>Orchestrates the entire process:</p>
<ul>
    <li>Extracts headers from <b>environment variables</b></li>
    <li>Writes the <i>configuration to the specified file</i></li>
    <li>Handles file operations safely with context managers</li>
</ul>

<h4>10. Script Entry Point</h4>
<pre><code class="lang-python">if __name__ == '__main__':
    main(os.environ, '/etc/nginx/headers.include')</code></pre>
<p>When run directly, processes the current environment and writes header configuration
to <b>/etc/nginx/headers.include</b>. This file can then be included in the main Nginx configuration.</p>

<h4>Overall Header Config Purpose</h4>
<p>This script enables <b>dynamic HTTP header management</b> for the Nginx container:</p>
<ul>
    <li><b>Security headers</b>: Add headers like X-Frame-Options, X-Content-Type-Options</li>
    <li><b>Custom application headers</b>: Include version info, API keys, or custom metadata</li>
    <li><b>CORS headers</b>: Configure cross-origin resource sharing</li>
    <li><b>Caching headers</b>: Control browser and proxy caching behavior</li>
    <li><b>Environment-specific headers</b>: Different headers for dev, test, and prod environments</li>
</ul>

<p>The beauty is that you can configure all these headers through <i>environment variables</i>
without rebuilding the container image, making deployment across different environments seamless.</p>
</pre></body></html></div>
</div>
</div>
<!--## 5.interation_tests #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-5.interation_tests">
<h2 class="foldable-title" id="foldable-title-5.interation_tests">5.interation_tests</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('5.interation_tests')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('tocco-CI-CD','editable-paragraph-5.interation_tests', 'foldable-content-penButton-5.interation_tests')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-5.interation_tests">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-5.interation_tests" onclick="save_editable_content('tocco-CI-CD','editable-paragraph-5.interation_tests', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-5.interation_tests"><pre><h4>Introduction: Integration Testing Purpose</h4>
<p>This integration test suite validates the <b>end-to-end behavior</b> of the Nginx container
by making real HTTP requests and verifying responses. It tests that all components work
together correctly: <i>header injection</i>, <b>proxy forwarding</b>, <i>caching behavior</i>,
<b>WebSocket support</b>, and various edge cases that might occur in production.</p>

<h4>1. Common Assertion Helper Function</h4>
<pre><code class="lang-python">def assert_response(path, code, *, some_header, some_always_header=True, source_ip='10.0.0.3'):
headers = { 'X-Forwarded-For': source_ip, 'X-Forwarded-Proto': 'https' }
r = requests.get('http://localhost:8081/{}'.format(path), allow_redirects=False, headers=headers)
assert r.status_code == code, 'got code {} but expected {} fetching {!r} with source IP {}'.format(r.status_code, code, path, source_ip)
assert not some_always_header or r.headers['Some-Always-Header'] == 'some always "value"'
assert not some_header or r.headers['Some-Header'] == 'some "value"'</code></pre>
<p>A <b>reusable test helper</b> that validates HTTP responses:</p>
<ul>
<li>Makes a request to <i>localhost:8081</i> (the Nginx container)</li>
<li>Simulates <b>OpenShift's routing headers</b> (X-Forwarded-For, X-Forwarded-Proto)</li>
<li>Verifies the <i>HTTP status code</i> matches expectations</li>
<li>Checks if the <b>custom headers</b> configured via environment variables are present</li>
<li>Tests both <i>conditional headers</i> (some_header) and <b>always headers</b> (some_always_header)</li>
</ul>

<h4>2. Cache Keying Test (Regression Test)</h4>
<pre><code class="lang-python">def test_cache_keying():
abc_net1 = requests.get('http://localhost:8081/cache', headers={'Host': 'abc.net', 'X-Forwarded-Proto': 'https', 'X-Forwarded-For': '10.0.0.3'})
assert abc_net1.headers['X-Cache'] == 'MISS'
# same schema, same host, same uri and same method → cached
abc_net2 = requests.get('http://localhost:8081/cache', headers={'Host': 'abc.net', 'X-Forwarded-Proto': 'https', 'X-Forwarded-For': '10.0.0.3'})
assert abc_net2.headers['X-Cache'] == 'HIT'</code></pre>
<p>Tests that <b>Nginx caching works correctly</b> and is properly isolated by:</p>
<ul>
<li><b>First request</b>: Cache miss, response gets cached</li>
<li><b>Second identical request</b>: Cache hit, same content returned</li>
<li><b>Different protocol</b> (http vs https): Separate cache entry (MISS)</li>
<li><b>Different hostname</b>: Separate cache entry (MISS)</li>
<li><b>Different HTTP method</b> (HEAD vs GET): Separate cache entry (MISS)</li>
</ul>
<p>This is a <i>regression test for bug #63270</i>, ensuring cache isolation
prevents data leakage between different virtual hosts.</p>

<h4>3. HTTP Method Preservation Test</h4>
<pre><code class="lang-python">def test_no_head_rewrite_to_get():
get = requests.get('http://localhost:8081/method', headers={'Host': 'abc.net', 'X-Forwarded-Proto': 'https', 'X-Forwarded-For': '10.0.0.3'})
assert get.headers['X-Method-Received'] == 'GET'
head = requests.head('http://localhost:8081/method', headers={'Host': 'abc.net', 'X-Forwarded-Proto': 'https', 'X-Forwarded-For': '10.0.0.3'})
assert head.headers['X-Method-Received'] == 'HEAD'</code></pre>
<p>Verifies that <b>HTTP methods are preserved</b> when proxying to the backend
application. Some proxy configurations incorrectly convert HEAD requests to GET
requests, which this test guards against.</p>

<h4>4. Health Endpoint Test</h4>
<pre><code class="lang-python">def test_unreachable():
assert_response('status-tocxxxooag-nginx', 200, some_header=False, some_always_header=False)
assert_response('bad-gateway', 502, some_header=False)</code></pre>
<p>Tests the <b>health check endpoint</b>:</p>
<ul>
<li><i>/status-tocxxxooag-nginx</i> always returns <b>200 OK</b> even if the backend application is down</li>
<li>This allows <b>OpenShift health checks</b> to distinguish between "Nginx is broken" vs "backend app is broken"</li>
<li>Other paths return <i>502 Bad Gateway</i> when the backend is unreachable</li>
<li>Note: No custom headers are added to error responses (some_header=False)</li>
</ul>

<h4>5. Basic Proxying Test</h4>
<pre><code class="lang-python">def test_proxying():
assert_response('200', 200, some_header=True)
assert_response('404', 404, some_header=False)
assert_response('500', 500, some_header=False)</code></pre>
<p>Validates <b>request proxying</b> and header behavior:</p>
<ul>
<li><b>Success responses (200)</b>: Custom headers are added</li>
<li><b>Error responses (404, 500)</b>: Custom headers are NOT added (conditional headers)</li>
<li>Ensures the backend application's responses are <i>correctly forwarded</i></li>
</ul>

<h4>6. Timeout Configuration Test</h4>
<pre><code class="lang-python">def test_timeout():
print('Testing 4 minute timeout. Be patient.')
assert_response('time=240', 200, some_header=True)</code></pre>
<p>Verifies that the <b>proxy timeout is properly configured</b>. The default
Nginx timeout of 60 seconds would cause this test to fail. This ensures
<i>long-running requests</i> (like file uploads or complex computations)
can complete without timing out.</p>

<h4>7. WebSocket Support Test</h4>
<pre><code class="lang-python">def test_websocket():
resp = requests.get(
'http://localhost:8081/websocket',
allow_redirects=False,
headers={
'Connection': 'Upgrade',
'Upgrade': 'WebSocket',
'X-Forwarded-For': '10.0.0.3',
'X-Forwarded-Proto': 'https',
}
)
resp.raise_for_status()</code></pre>
<p>Tests that <b>WebSocket upgrade headers</b> are correctly forwarded
to the backend. WebSocket connections require special <i>Connection: Upgrade
</i> and <i>Upgrade: WebSocket</i> headers to establish the connection.</p>

<h4>8. Header Filtering Test</h4>
<pre><code class="lang-python">def test_no_websocket():
resp = requests.get(
'http://localhost:8081/no-websocket',
allow_redirects=False,
headers = {
'X-Forwarded-For': '10.0.0.3',
'X-Forwarded-Proto': 'https',
}
)
resp.raise_for_status()</code></pre>
<p>Verifies that when <b>WebSocket headers are NOT present</b>, they're not
sent to the backend. This tests proper header filtering and ensures the backend
doesn't receive unexpected headers.</p>

<h4>9. Security.txt Compliance Test</h4>
<pre><code class="lang-python">def test_security_txt():
resp = requests.get('http://localhost:8081/.well-known/security.txt')
resp.raise_for_status()
assert 'Expires: 20' in resp.text
resp = requests.get('http://localhost:8081/security.txt')
resp.raise_for_status()
assert 'Expires: 20' in resp.text
resp = requests.get('http://localhost:8081/security.txt', allow_redirects=False)
resp.raise_for_status()
assert resp.headers['Location'] == '/.well-known/security.txt'</code></pre>
<p>Tests <b>RFC 9116 security.txt</b> implementation:</p>
<ul>
<li>Verifies the file is accessible at <i>/.well-known/security.txt</i></li>
<li>Checks the <b>Expires field</b> was generated (starts with "20" for year 20xx)</li>
<li>Tests the <i>legacy /security.txt location</i> with redirect to the standard location</li>
<li>Ensures security contact information is properly exposed</li>
</ul>

<h4>10. Mock Application Context Manager</h4>
<pre><code class="lang-python">class mock:
def __init__(self):
self.mock = None
def __enter__(self):
self.mock = Process(target=nice_mock.run)
self.mock.start()
# wait for mock to become ready
while True:
try:
requests.get('http://localhost:8080/200')
except requests.exceptions.ConnectionError:
print('waiting for mock …')
time.sleep(0.5)
else:
break
def __exit__(self, a, b, c):
if self.mock is not None:
self.mock.terminate()</code></pre>
<p>A <b>context manager</b> that manages the mock backend application:</p>
<ul>
<li>Starts the <i>nice_mock.py</i> server in a separate process</li>
<li><b>Waits for readiness</b> by polling until it responds</li>
<li>Automatically <i>cleans up</i> (terminates) the mock server when tests complete</li>
<li>Ensures tests have a <b>working backend</b> to proxy to</li>
</ul>

<h4>11. Main Test Orchestration</h4>
<pre><code class="lang-python">def main():
test_security_txt()
test_unreachable()
with mock():
test_cache_keying()
test_no_head_rewrite_to_get()
test_proxying()
test_timeout()
test_websocket()
test_no_websocket()</code></pre>
<p>Orchestrates test execution in <b>logical order</b>:</p>
<ul>
<li>First runs tests that <i>don't need the backend</i> (security.txt, health endpoint)</li>
<li>Then starts the mock backend and runs <b>proxy-dependent tests</b></li>
<li>Ensures proper <i>setup and teardown</i> of test dependencies</li>
</ul>

<h4>Overall Integration Test Purpose</h4>
<p>This comprehensive test suite validates the <b>production readiness</b> of
your Nginx container:</p>
<ul>
<li><b>Header management</b>: Custom headers work correctly</li>
<li><b>Proxy functionality</b>: Requests are correctly forwarded to backends</li>
<li><b>Cache isolation</b>: No data leakage between different virtual hosts</li>
<li><b>WebSocket support</b>: Modern web applications can use WebSockets</li>
<li><b>Timeout handling</b>: Long-running requests don't fail prematurely</li>
<li><b>Security compliance</b>: RFC-compliant security.txt implementation</li>
<li><b>Health monitoring</b>: OpenShift can properly monitor container health</li>
</ul>

<p>These tests ensure that the <i>dynamically configured Nginx container</i>
will behave correctly in production OpenShift environments with real applications.</p>
</pre></div>
</div>
</div>
<!--## 6.mock #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-6.mock">
<h2 class="foldable-title" id="foldable-title-6.mock">6.mock</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('6.mock')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('tocco-CI-CD','editable-paragraph-6.mock', 'foldable-content-penButton-6.mock')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-6.mock">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-6.mock" onclick="save_editable_content('tocco-CI-CD','editable-paragraph-6.mock', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-6.mock"><pre><h4>Introduction: Mock Backend Server Purpose</h4>
<p>This is a <b>lightweight test web server</b> that simulates a real backend application.
It runs on <i>port 8080</i> and provides various endpoints with specific behaviors to
test different Nginx proxy scenarios. The server's status code and behavior are determined
by the <b>URL path</b>, making it easy to test different HTTP response scenarios.</p>

<b>More infos</b> about the Server-Library <a href="https://docs.python.org/3/library/socketserver.html#socketserver.TCPServer">HERE</a>
and about implementing Webservers in generall <a href="https://www.brandonrohrer.com/http_server.html">HERE</a>

<h4>1. Request Handler Class Definition</h4>
<pre><code class="lang-python">class S(BaseHTTPRequestHandler):
    def do_GET(self):</code></pre>
<p>Defines the main <b>HTTP request handler</b> that processes GET requests.
Inherits from Python's BaseHTTPRequestHandler to handle HTTP protocol details
automatically. Using this class abstracts away a lot of things that we do not really
want to deal with. In the end we only need to defined the on_GET(), on_PUT() ..etc.
methods that tell the handler how to Deal with defined requests</p>

<h4>2. Cache Testing Endpoint</h4>
This gets called from <b>integration_tests.py</b>s <i>test_cache_keying()</i>.
Python's requests library creates an HTTP GET request:
 - Target: http://localhost:8081/cache
 - Port 8081 is where <i>Nginx</i> is listening

<pre><code class="lang-python">
 # Test Script
 #  ↓ HTTP GET /cache
 # Nginx (localhost:8081)
 #  ↓ Checks: "Is this in my cache?"
 #  ↓ First time: NO (cache MISS)
 #  ↓ "I need to get it from backend"
 #  ↓ proxy_pass http://localhost:8080/cache
 # Mock Server (localhost:8080)
</code></pre>
Inside <b>nice_mock.py</b>, Python's HTTP server automatically
<pre><code class="lang-python">
# HTTP server sees incoming request
# Parses: "GET /cache HTTP/1.1"
# Creates instance of handler class S
# Looks at HTTP method: GET
# Calls: do_GET()
        if self.path == '/cache':
            body = str(uuid.uuid4())
            self.send_response(200)
            self.send_header('Cache-Control', 'public, max-age=86400')

# public: Can be cached by any cache (proxies, CDNs, browsers)
# max-age=86400: Cache is valid for 86400 seconds (24 hours)
# Tells Nginx: "You can store this response and reuse it
</code></pre>

<p>Generates <b>unique content for cache testing</b> this method is underneath the <b>do_GET()</b>:
Example: <b>"550e8400-e29b-41d4-a716-446655440000"</b> Every call produces a <b>different</b> UUID
</p>
<ul>
    <li>Returns a <i>random UUID</i> as the response body</li>
    <li>Sets <b>Cache-Control header</b> allowing caching for 24 hours (86400 seconds)</li>
    <li>Enables testing whether Nginx properly caches responses and serves them correctly</li>
    <li>Each request gets a <i>unique UUID</i>, so cache HITs vs MISSes can be distinguished</li>
</ul>


<pre><code class="lang-python">
┌──────────────────────────────────────────────────────────┐
│ First Request (Cache MISS)                               │
└──────────────────────────────────────────────────────────┘

Test                 Nginx                 Mock Server
  │                    │                        │
  ├─GET /cache────────+│                        │
  │                    ├─Check cache            │
  │                    │  (empty)               │
  │                    │                        │
  │                    ├─GET /cache────────────+│
  │                    │                        ├─uuid.uuid4()
  │                    │                        │  "uuid-ABC"
  │                    │                        │
  │                    │+──200 + "uuid-ABC"─────┤
  │                    │                        │
  │                    ├─Store in cache:        │
  │                    │  ["uuid-ABC"]          │
  │                    │                        │
  │+──200 + "uuid-ABC"─┤                        │
  │   X-Cache: MISS    │                        │
  │                    │                        │
┌──────────────────────────────────────────────────────────┐
│ Second Request (Cache HIT)                               │
└──────────────────────────────────────────────────────────┘
Test                 Nginx                 Mock Server
  │                    │                        │
  ├─GET /cache────────+│                        │
  │                    ├─Check cache            │
  │                    │  (found: "uuid-ABC")   │
  │                    │                        │
  │                    │   NO request to mock!  │
  │                    │                        │
  │+──200 + "uuid-ABC"─┤                        │
  │   X-Cache: HIT     │                        │
  │                    │                        │
</code>
</pre>

<h4>3. Timeout Testing Endpoint</h4>
<pre><code class="lang-python">        elif self.path.startswith('/time='):
            time.sleep(int(self.path[6:]))
            self.send_response(200)</code></pre>
<p>Simulates <b>slow/long-running requests</b>:</p>
<ul>
    <li>Extracts the number from the path (e.g., <i>/time=240</i> means 240 seconds)</li>
    <li><b>Sleeps</b> for the specified duration before responding</li>
    <li>Used to test that Nginx's <i>proxy timeout</i> is configured correctly</li>
    <li>Ensures long-running operations don't get cut off prematurely</li>
</ul>

<h4>4. Health Check Endpoint</h4>
<pre><code class="lang-python">        elif self.path == '/status-tocxxxooag':
            self.send_response(200)</code></pre>
<p>Simple <b>health check endpoint</b> that always returns 200 OK. This might
be used by the backend application's own health checks (separate from Nginx's
health endpoint).</p>

<h4>5. WebSocket Upgrade Testing</h4>
<pre><code class="lang-python">        elif self.path == '/websocket':
            if self.headers['Upgrade'].lower() == 'websocket' \
                    and self.headers['Connection'].lower() == 'upgrade':
                status = 101
            else:
                status = 500
            self.send_response(status)</code></pre>
<p>Tests <b>WebSocket header forwarding</b>:</p>
<ul>
    <li>Checks if both <i>Upgrade: websocket</i> and <i>Connection: upgrade</i> headers are present</li>
    <li>Returns <b>101 Switching Protocols</b> if headers are correct (proper WebSocket upgrade)</li>
    <li>Returns <b>500 Internal Server Error</b> if headers are missing or incorrect</li>
    <li>Validates that Nginx correctly <i>forwards WebSocket upgrade headers</i> to the backend</li>
</ul>

<h4>6. Header Filtering Validation</h4>
<pre><code class="lang-python">        elif self.path == '/no-websocket':
            if 'Upgrade' not in self.headers \
                    and 'Connection' not in self.headers:
                status = 200
            else:
                status = 500
            self.send_response(status)</code></pre>
<p>Tests that <b>WebSocket headers are NOT present</b> when they shouldn't be:</p>
<ul>
    <li>Returns <b>200 OK</b> if neither Upgrade nor Connection headers are present</li>
    <li>Returns <b>500</b> if these headers exist (indicating improper header forwarding)</li>
    <li>Ensures Nginx doesn't <i>leak or add unexpected headers</i> to normal requests</li>
</ul>

<h4>7. HTTP Method Verification</h4>
<pre><code class="lang-python">        elif self.path == '/method':
            self.send_response(200)
            self.send_header('X-Method-Received','GET')
            self.end_headers()</code></pre>
<p>Echoes back the <b>HTTP method received</b>:</p>
<ul>
    <li>Returns a custom header <i>X-Method-Received</i> indicating which method was used</li>
    <li>Allows tests to verify Nginx doesn't <b>transform HTTP methods</b> (e.g., HEAD to GET)</li>
    <li>Ensures proper <i>method preservation</i> through the proxy</li>
</ul>

<h4>8. Dynamic Status Code Endpoint</h4>
<pre><code class="lang-python">        else:
            code = int(self.path[1:])
            self.send_response(code)
        self.end_headers()
        self.wfile.write(body.encode())</code></pre>
<p>The <b>default behavior</b> for any other path:</p>
<ul>
    <li>Extracts the status code from the URL path (e.g., <i>/404</i> returns 404, <i>/200</i> returns 200)</li>
    <li>Allows testing <i>any HTTP status code</i> by simply changing the URL</li>
    <li>Writes the response body (if any) and completes the response</li>
    <li>Makes it easy to test Nginx behavior with different status codes</li>
</ul>

<h4>9. HEAD Request Handler</h4>
<pre><code class="lang-python">    def do_HEAD(self):
        if self.path == '/method':
            self.send_response(200)
            self.send_header('X-Method-Received', 'HEAD')
            self.end_headers()
        elif self.path == '/cache':
            self.send_response(200)
            self.send_header('Cache-Control', 'public, max-age=86400')
        else:
            raise ValueError(f'unexpected path {self.path!r}')
        self.end_headers()</code></pre>
<p>Handles <b>HEAD requests</b> separately:</p>
<ul>
    <li>For <i>/method</i>: Returns <b>X-Method-Received: HEAD</b> to verify method preservation</li>
    <li>For <i>/cache</i>: Returns the same headers as GET (for cache testing)</li>
    <li>For other paths: Raises an error (forces tests to be explicit about HEAD support)</li>
    <li>HEAD requests should return <i>headers without a body</i></li>
</ul>

<h4>10. IPv6-Enabled HTTP Server</h4>
<pre><code class="lang-python">class CustomHTTPServer(HTTPServer):
    address_family = socket.AF_INET6</code></pre>
<p>Customizes the HTTP server to support <b>IPv6</b>:</p>
<ul>
    <li>Sets the address family to <i>AF_INET6</i> instead of the default AF_INET (IPv4)</li>
    <li>Enables <b>dual-stack networking</b> (IPv4 and IPv6) on modern systems</li>
    <li>Ensures compatibility with <i>IPv6-enabled environments</i></li>
</ul>

<h4>11. Server Startup Function</h4>
<pre><code class="lang-python">def run(server_class=CustomHTTPServer, handler_class=S):
    server_address = ('', 8080)
    httpd = server_class(server_address, handler_class)
    httpd.serve_forever()</code></pre>
<p>Starts the mock server:</p>
<ul>
    <li>Binds to <b>port 8080</b> on all network interfaces</li>
    <li>Uses the <i>CustomHTTPServer</i> class (IPv6-enabled)</li>
    <li>Runs <b>indefinitely</b> with serve_forever() until terminated</li>
    <li>This is the server that Nginx proxies to during integration tests</li>
</ul>

<h4>12. Script Entry Point</h4>
<pre><code class="lang-python">if __name__ == "__main__":
    run()</code></pre>
<p>Starts the server when the script is run directly.</p>

<h4>Overall Mock Server Purpose</h4>
<p>This mock server is a <b>testing Swiss Army knife</b> that provides:</p>
<ul>
    <li><b>Dynamic status codes</b>: Test any HTTP response code by changing the URL</li>
    <li><b>Cache testing</b>: Unique responses to verify cache behavior</li>
    <li><b>Timeout simulation</b>: Test long-running request handling</li>
    <li><b>WebSocket validation</b>: Ensure proper header forwarding</li>
    <li><b>Method preservation</b>: Verify HTTP methods aren't transformed</li>
    <li><b>Header filtering</b>: Confirm unwanted headers aren't leaked</li>
</ul>

<p>The server's <i>path-based behavior</i> makes it extremely flexible for
testing different scenarios without needing multiple test servers. It simulates
a real backend application's behavior patterns, allowing comprehensive integration
testing of the Nginx proxy configuration.</p>
</pre></div>
</div>
</div>


<div class="foldable-container" id="foldcontainer-7.test_header_config">
<h2 class="foldable-title" id="foldable-title-7.test_header_config">7.test_header_config</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('7.test_header_config')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('tocco-CI-CD','editable-paragraph-7.test_header_config', 'foldable-content-penButton-7.test_header_config')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-7.test_header_config">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-7.test_header_config" onclick="save_editable_content('tocco-CI-CD','editable-paragraph-7.test_header_config', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-7.test_header_config"><pre><h4>Introduction: Unit Testing Purpose</h4>
<p>This is a <b>unit test</b> for the <i>header_config.py</i> script. It validates
that environment variables are correctly transformed into Nginx configuration
directives. Unlike integration tests that test the whole system, this tests <b>just
one component in isolation</b> with controlled inputs and expected outputs.</p>


<h4>1. Test Setup and Imports</h4>
<pre><code class="lang-python">import header_config
import tempfile
import textwrap
import unittest</code></pre>
<p>Imports necessary modules:</p>
<ul>
    <li><b>header_config</b>: The module being tested</li>
    <li><b>tempfile</b>: Creates temporary files for testing without cluttering the filesystem</li>
    <li><b>textwrap</b>: Helps format multi-line strings cleanly (removes indentation)</li>
    <li><b>unittest</b>: Python's built-in testing framework</li>
</ul>


<h4>2. Test Class Definition</h4>
<pre><code class="lang-python">class Test(unittest.TestCase):
    def test_main(self):</code></pre>
<p>Defines a <b>test case class</b> that inherits from unittest.TestCase,
providing testing utilities and assertion methods.</p>


<h4>3. Mock Environment Variables</h4>
<pre><code class="lang-python">        env = {
            'NGINX_HEADER_Strict-Transport-Security': 'max-age=86400',
            'ignored': 'ignored',
            'NGINX_HEADER_a_name': r'value in need of escaping "\"',
            'NGINX_HEADER_name-with__hyphens': 'double__underscores__not__replaced__here',
            'NGINX_ALWAYS_HEADER_Always': 'present even on error pages'
        }</code></pre>
<p>Creates a <b>mock environment dictionary</b> to test various scenarios:</p>
<ul>
    <li><b>'NGINX_HEADER_Strict-Transport-Security'</b>: Tests a standard security header</li>
    <li><b>'ignored'</b>: Tests that non-NGINX_HEADER variables are <i>not processed</i></li>
    <li><b>'NGINX_HEADER_a_name'</b>: Tests <i>special character escaping</i> (quotes and backslashes)</li>
    <li><b>'NGINX_HEADER_name-with__hyphens'</b>: Tests that <b>double
underscores in the header NAME</b> become hyphens, but double underscores
<i>in the VALUE</i> stay unchanged</li>
    <li><b>'NGINX_ALWAYS_HEADER_Always'</b>: Tests the "always" flag for error page headers</li>
</ul>


<h4>4. Temporary File Creation</h4>
<pre><code class="lang-python">        with tempfile.NamedTemporaryFile(mode='w+') as f:
            header_config.main(env, f.name)</code></pre>
<p>Uses a <b>context manager</b> to create a temporary file:</p>
<ul>
    <li>The file is automatically <i>cleaned up</i> when the test completes</li>
    <li>Calls <b>header_config.main()</b> with the mock environment and temp file path</li>
    <li>This generates the Nginx configuration file just like in production</li>
</ul>


<h4>5. Output Verification</h4>
<pre><code class="lang-python">            self.assertEqual(f.read(), textwrap.dedent(r"""
                # DO NOT EDIT MANUALLY!
                # content is generated based on NGINX_HEADER_* and NGINX_ALWAYS_HEADER_* environment variables
                add_header "Always" "present even on error pages" always;
                add_header "Strict-Transport-Security" "max-age=86400";
                add_header "a_name" "value in need of escaping \"\\\"";
                add_header "name-with-hyphens" "double__underscores__not__replaced__here";
            """).lstrip())</code></pre>
<p>Asserts that the <b>generated configuration matches expectations exactly</b>. Let's break down what's being verified:</p>


<h4>5.1. Comment Headers</h4>
<pre><code class="lang-nginx"># DO NOT EDIT MANUALLY!
# content is generated based on NGINX_HEADER_* and NGINX_ALWAYS_HEADER_* environment variables</code></pre>
<p>Verifies that <b>warning comments</b> are included in the generated file.</p>


<h4>5.2. Always Header</h4>
<pre><code class="lang-nginx">add_header "Always" "present even on error pages" always;</code></pre>
<p>Confirms that <i>NGINX_ALWAYS_HEADER_Always</i> becomes an
<b>add_header directive with the "always" flag</b>, meaning it will be sent even on error responses (4xx, 5xx).</p>


<h4>5.3. Standard Header</h4>
<pre><code class="lang-nginx">add_header "Strict-Transport-Security" "max-age=86400";</code></pre>
<p>Verifies a <b>regular header</b> (without "always" flag) is generated correctly.
This header will only be sent on successful responses (2xx, 3xx).</p>


<h4>5.4. Escaped Characters</h4>
<pre><code class="lang-nginx">add_header "a_name" "value in need of escaping \"\\\"</code></pre>
<p>Tests that <b>special characters are properly escaped</b>:</p>
<ul>
    <li>Input: <i>'value in need of escaping "\\"'</i></li>
    <li>Output: <i>"value in need of escaping \"\\\""</i></li>
    <li>Quotes are escaped as <b>\"</b></li>
    <li>Backslashes are escaped as <b>\\</b></li>
    <li>This prevents <i>configuration syntax errors</i> in Nginx</li>
</ul>


<h4>5.5. Underscore Handling</h4>
<pre><code class="lang-nginx">add_header "name-with-hyphens" "double__underscores__not__replaced__here";</code></pre>
<p>Validates the <b>selective underscore replacement logic</b>:</p>
<ul>
    <li>Header name: <i>name-with__hyphens</i> → <b>name-with-hyphens</b> (double underscores become hyphens)</li>
    <li>Header value: <i>double__underscores__not__replaced__here</i> → stays unchanged</li>
    <li>This allows using proper HTTP header names (which use hyphens) while working
within <i>environment variable naming constraints</i> (which can't contain hyphens)</li>
</ul>


<h4>6. Alphabetical Ordering</h4>
<p>Notice the headers are <b>sorted alphabetically</b> by name:</p>
<ul>
    <li>Always</li>
    <li>Strict-Transport-Security</li>
    <li>a_name</li>
    <li>name-with-hyphens</li>
</ul>
<p>This ensures <i>consistent, predictable output</i> regardless of the order environment variables are defined.</p>


<h4>7. What's NOT in the Output</h4>
<p>The test also verifies that:</p>
<ul>
    <li>The <b>'ignored'</b> variable is NOT included (doesn't start with NGINX_HEADER_ or NGINX_ALWAYS_HEADER_)</li>
    <li>Only relevant environment variables are processed</li>
    <li>The script <i>filters correctly</i></li>
</ul>


<h4>Overall Unit Test Purpose</h4>
<p>This test validates the <b>core functionality</b> of header_config.py:</p>
<ul>
    <li><b>Environment variable parsing</b>: Correctly identifies NGINX_HEADER_* variables</li>
    <li><b>Name transformation</b>: Double underscores → hyphens in header names only</li>
    <li><b>Special character escaping</b>: Prevents configuration syntax errors</li>
    <li><b>Always flag handling</b>: Properly distinguishes conditional vs. always headers</li>
    <li><b>Filtering</b>: Ignores non-header environment variables</li>
    <li><b>Output formatting</b>: Generates valid Nginx configuration syntax</li>
    <li><b>Alphabetical sorting</b>: Ensures consistent output</li>
</ul>


<p>This <i>unit test</i> runs quickly and doesn't require a running Nginx container,
making it ideal for catching bugs early in development. Combined with the
<b>integration tests</b>, it ensures the header configuration system works correctly
both in isolation and in the complete system.</p>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</body></html><!--## 7.test_header_config #################################################################################################################--><!--## 1.Pipeline-Trigger-gitlab-ci.yml #################################################################################################################-->