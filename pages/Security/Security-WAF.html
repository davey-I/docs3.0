<!DOCTYPE html>

<html><head>
<title data-folder-path="/Security">Security-WAF</title>
<link href=" ../../static/style.css" rel="stylesheet"/>
<link href="../../prism/prism.css" rel="stylesheet"/>
</head>
<body class="body">
<div class="page-folder-header-div">
<h1 class="pagetitle" data-folder-path="Security">Security-WAF</h1>
<a href="./../..">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M3 11L12 4L21 11"></path>
<path d="M5 10V20H19V10"></path>
<path d="M10 20V14H14V20"></path>
</svg>
</a>
</div>
<!-- Sidebar -->
<div class="sidbear-enclosure-open" id="sidbear-enclosure-open-Security-WAF">
<button class="sidbear-enclosure-button-open" id="sidbear-enclosure-button-Security-WAF" onclick="toggle_sidebar()" type="button">
<svg fill="white" height="30" viewbox="0 0 100 80" width="30" xmlns="http://www.w3.org/2000/svg">
<rect height="10" width="100"></rect>
<rect height="10" width="100" y="30"></rect>
<rect height="10" width="100" y="60"></rect>
</svg>
</button>
<div class="sidebar-mainbox-open" id="sidebar-mainbox-Security-WAF">
<div class="sidebar-subbox-open" id="sidebar-subbox-1" onclick=" append_foldable_content()">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="10"></circle>
<line x1="12" x2="12" y1="8" y2="16"></line>
<line x1="8" x2="16" y1="12" y2="12"></line>
</svg>
</div>
<div class="sidebar-subbox-open" id="sidebar-subbox-2">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="10"></circle>
<path d="M9.09 9C9.32591 8.33109 9.78918 7.76807 10.4 7.41421C11.0108 7.06036 11.7266 6.93913 12.4152 7.07107C13.1038 7.20302 13.7206 7.57857 14.162 8.12132C14.6034 8.66407 14.8397 9.33984 14.83 10.03C14.83 12 12.5 12.5 12.5 14"></path>
<circle cx="12" cy="17" r="1"></circle>
</svg>
</div>
<div class="sidebar-subbox-open" id="sidebar-subbox-3">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="10"></circle>
<path d="M9.09 9C9.32591 8.33109 9.78918 7.76807 10.4 7.41421C11.0108 7.06036 11.7266 6.93913 12.4152 7.07107C13.1038 7.20302 13.7206 7.57857 14.162 8.12132C14.6034 8.66407 14.8397 9.33984 14.83 10.03C14.83 12 12.5 12.5 12.5 14"></path>
<circle cx="12" cy="17" r="1"></circle>
</svg>
</div>
</div>
</div>
<script src="../../prism/prism.js"></script>
<script src="../../static/script.js"></script>
<!--## Security-WAF-Implementation-Options #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-Security-WAF-Implementation-Options">
<h2 class="foldable-title" id="foldable-title-Security-WAF-Implementation-Options">Security-WAF-Implementation-Options</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('Security-WAF-Implementation-Options')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewbox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Security-WAF','editable-paragraph-Security-WAF-Implementation-Options', 'foldable-content-penButton-Security-WAF-Implementation-Options')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<button class="create-subdiv" id="create-subdiv-Security-WAF-Implementation-Options" onclick="add_subdiv('editable-paragraph-Security-WAF-Implementation-Options')" type='*button"'>
<svg class="add-tag-icon" fill="none" height="22" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
<!-- < and > symbols -->
<path d="M6 8l-4 4 4 4"></path> <!-- Left angle bracket -->
<path d="M18 8l4 4-4 4"></path> <!-- Right angle bracket -->
<!-- Plus sign in center -->
<path d="M12 10v4"></path>
<path d="M10 12h4"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-Security-WAF-Implementation-Options">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-Security-WAF-Implementation-Options" onclick="save_editable_content('Security-WAF','editable-paragraph-Security-WAF-Implementation-Options', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-Security-WAF-Implementation-Options"><li>A basic distinction must be made between whether a WAF is used as:</li>
<ul>
  <h3>Webserver-Modul (e.g., OWASP ModSecurity)</h3>
  <ul>
    <li>WAF runs as a plugin/module directly integrated into the web server software (e.g., Apache, Nginx, IIS).</li>
    <li><b>ModSecurity</b> is the most common example; it inspects HTTP traffic at the web server level.</li>
    <li>It works at <b>Layer 7 (Application Layer)</b> and filters HTTP(S) traffic</li><br/>
    <li><b>Advantages:</b></li>
    <ul>
      <li>Fine-grained control over HTTP traffic (request/response).</li>
      <li>Low latency overhead because it's in-process with the web server.</li>
      <li>Easier to deploy in development or staging environments.</li>
      <li>Supports custom rules and tight integration with the specific app stack.</li>
    </ul>
    <li><b>Disadvantages:</b></li>
    <ul>
      <li>Consumes server resources (CPU/RAM), especially under high traffic.</li>
      <li>Harder to scale horizontally (requires configuring WAF rules per web server).</li>
      <li>Limited protection if the server is already compromised.</li>
    </ul>
  </ul>


  <h3>Part of a Firewall (e.g., Next-Generation Firewall with WAF features)</h3>
  <ul>
    <li>WAF functionality is embedded in a broader security device like a NGFW (e.g., Palo Alto, Fortinet, Sophos).</li>
    <li><b>Advantages:</b></li>
    <ul>
      <li>Centralized network security management (firewall, IPS, AV, WAF combined).</li>
      <li>Often vendor-managed with automatic signature and rule updates.</li>
      <li>Good integration in hybrid environments, inspecting L3–L7 traffic.</li>
    </ul>
    <li><b>Disadvantages:</b></li>
    <ul>
      <li>More costly (typically enterprise-level appliances or subscriptions).</li>
      <li>May lack deep application-layer customization.</li>
      <li>Less agile for DevOps/CI-CD driven deployments.</li>
    </ul>
  </ul>


  <h3>Upstream Appliance (dedicated appliance or reverse proxy WAF)</h3>
  <ul>
    <li>Standalone physical or virtual appliance placed in front of web servers (e.g., F5 ASM, AWS WAF, Cloudflare WAF).</li>
    <li>Acts as a reverse proxy inspecting and filtering all incoming HTTP/S traffic.</li>
    <li><b>Advantages:</b></li>
    <ul>
      <li>Isolation from application servers – harder to bypass.</li>
      <li>High scalability – can be deployed in clusters and behind load balancers.</li>
      <li>Additional features: SSL termination, caching, rate limiting, DDoS and bot protection.</li>
      <li>Centralized rule management across multiple services.</li>
    </ul>
    <li><b>Disadvantages:</b></li>
    <ul>
      <li>May add latency if not properly optimized.</li>
      <li>Requires network and DNS configuration changes.</li>
      <li>Some solutions are expensive or complex to maintain.</li>
    </ul>
  </ul>
</ul>
</div>
</div>
</div>
<!--## modsecurity #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-modsecurity">
<h2 class="foldable-title" id="foldable-title-modsecurity">modsecurity</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('modsecurity')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewbox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Security-WAF','editable-paragraph-modsecurity', 'foldable-content-penButton-modsecurity')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<button class="create-subdiv" id="create-subdiv-modsecurity" onclick="add_subdiv('editable-paragraph-modsecurity')" type='*button"'>
<svg class="add-tag-icon" fill="none" height="22" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg">
<!-- < and > symbols -->
<path d="M6 8l-4 4 4 4"></path> <!-- Left angle bracket -->
<path d="M18 8l4 4-4 4"></path> <!-- Right angle bracket -->
<!-- Plus sign in center -->
<path d="M12 10v4"></path>
<path d="M10 12h4"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-modsecurity">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-modsecurity" onclick="save_editable_content('Security-WAF','editable-paragraph-modsecurity', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-modsecurity"><pre>- <b>Logs</b>: Can be found at <i>/var/log/apache2/modsec_audit.log</i>
<div class="foldable-container" id="foldcontainer-Steup-Apache2-Modsecurity">
<h2 class="foldable-title" id="foldable-title-Steup-Apache2-Modsecurity">Steup-Apache2-Modsecurity</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('Steup-Apache2-Modsecurity')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewbox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Security-WAF','editable-paragraph-Steup-Apache2-Modsecurity', 'foldable-content-penButton-Steup-Apache2-Modsecurity')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-Steup-Apache2-Modsecurity">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-Steup-Apache2-Modsecurity" onclick="save_editable_content('Security-WAF','editable-paragraph-Steup-Apache2-Modsecurity', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-Steup-Apache2-Modsecurity"><h4>Step 1: Install ModSecurity with Apache on Debian/Ubuntu</h4>

The ModSecurity module for Apache is included in the default Debian/Ubuntu repository. To install it, run

<pre><code class="lang-bash">sudo apt install libapache2-mod-security2</code></pre>
Then enable this module.

<pre><code class="lang-bash">sudo a2enmod security2</code></pre>
Restart Apache for the change to take effect.

<pre><code class="lang-bash">sudo systemctl restart apache2</code></pre>

<h4>Step 2: Configure ModSecurity</h4>
In the <b>/etc/apache2/mods-enabled/security2.conf</b> configuration file, you can find the following line.

IncludeOptional /etc/modsecurity/*.conf

<img alt="blaaa" height="180" src="../../images/sudo-a2enmod-security2.png" width="600"/>

This means Apache will include all the <b>*.conf</b> files in <b>/etc/modsecurity/</b> directory. We need to rename
the <b>modsecurity.conf-recommended</b> file to make it work.

<pre><code class="lang-bash">sudo mv /etc/modsecurity/modsecurity.conf-recommended /etc/modsecurity/modsecurity.conf</code></pre>
Then edit this file with a command-line text editor like Nano.

<pre><code class="lang-bash">sudo nano /etc/modsecurity/modsecurity.conf</code></pre>
Find the following line.

SecRuleEngine DetectionOnly
This config tells ModSecurity to log HTTP transactions, but takes no action when an attack is detected.
Change it to the following, so ModSecurity will detect and block web attacks.

SecRuleEngine On
Then find the following line (line 186), which tells ModSecurity what information should be included in the audit log.

SecAuditLogParts ABDEFHIJZ
However, the default setting is wrong. You will know why later when I explain how to understand ModSecurity logs.
The setting should be changed to the following.

SecAuditLogParts ABCEFHJKZ
Save and close the file. Then restart Apache for the change to take effect. (Reloding the web server isn’t enough.)

<pre><code class="lang-bash">sudo systemctl restart apache2</code></pre>

<h4>Step 3: Install the OWASP Core Rule Set (CRS)</h4>

To make ModSecurity protect your web applications, you need to define rules to detect malicious actors and block them. For beginners, it’s a good idea to install existing rule sets, so you can get started quickly and then learn the nitty-gritty down the road. There are several free rule sets for ModSecurity. The OWASP Core Rule Set (CRS) is the standard rule set used with ModSecurity.

- It’s free, community-maintained and the most widely used rule set that provides a sold default configuration for ModSecurity.
- It contains rules to help stop common attack vectors, including SQL injection (SQLi), cross-site scripting (XSS), and many others.
- It can integrate with Project Honeypot.
- It also contains rules to detect bots and scanners.
- It has been tuned through wide exposure to have very few false positives.

When installing ModSecurity from the default Debian/Ubuntu repository, the modsecurity-crs package
is also installed as a dependency. This package contains the OWASP core rule set version 3.x. However,
it can become out of date. If you care about security, you should use the latest version of core rule set.

Download the latest OWASP CRS from GitHub.

wget https://github.com/coreruleset/coreruleset/archive/v3.3.0.tar.gz
Extract the file.

tar xvf v3.3.0.tar.gz
Create a directory to store CRS files.

<pre><code class="lang-bash">sudo mkdir /etc/apache2/modsecurity-crs/</code></pre>
Move the extracted directory to /etc/apache2/modsecurity-crs/.

<pre><code class="lang-bash">sudo mv coreruleset-3.3.0/ /etc/apache2/modsecurity-crs/</code></pre>
Go to that directory.

cd /etc/apache2/modsecurity-crs/coreruleset-3.3.0/
Rename the crs-setup.conf.example file.

<pre><code class="lang-bash">sudo mv crs-setup.conf.example crs-setup.conf</code></pre>
Edit the /etc/apache2/mods-enabled/security2.conf file.


<pre><code class="lang-bash">sudo nano /etc/apache2/mods-enabled/security2.conf</code></pre>
Find the following line, which loads the default CRS files.

IncludeOptional /usr/share/modsecurity-crs/*.load
Change it to the following, so the latest OWASP CRS will be used.

IncludeOptional /etc/apache2/modsecurity-crs/coreruleset-3.3.0/crs-setup.conf
IncludeOptional /etc/apache2/modsecurity-crs/coreruleset-3.3.0/rules/*.conf

<img alt="blaaa" height="180" src="../../images/apache-Install-the-OWASP-Core-Rule-Set-CRS-debian-ubuntu.png" width="600"/>

Save and close the file. Then test Apache configuration.

<pre><code class="lang-bash">sudo apache2ctl -t</code></pre>
If the syntax is OK, then restart Apache.

<pre><code class="lang-bash">sudo systemctl restart apache2</code></pre>
</div>
</div>
</div>
</pre>
<div class="foldable-container" id="foldcontainer-How-OWASP-CRS-Works">
<h2 class="foldable-title" id="foldable-title-How-OWASP-CRS-Works">How-OWASP-CRS-Works</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('How-OWASP-CRS-Works')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewbox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Security-WAF','editable-paragraph-How-OWASP-CRS-Works', 'foldable-content-penButton-How-OWASP-CRS-Works')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-How-OWASP-CRS-Works">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-How-OWASP-CRS-Works" onclick="save_editable_content('Security-WAF','editable-paragraph-How-OWASP-CRS-Works', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-How-OWASP-CRS-Works"><pre>Let’s take a look at the CRS config file, which provides you with good documentation on how CRS works.


<pre><code class="lang-bash">
 sudo nano /etc/apache2/modsecurity-crs/coreruleset-3.3.0/crs-setup.conf
</code></pre>

You can see that <b>OWASP CRS</b> can run in two modes:

<i>self-contained mode</i>. This is the traditional mode used in CRS v2.x. If an HTTP request matches 
a rule, ModSecurity will block the HTTP request immediately and stop evaluating remaining rules.

<i>anomaly scoring mode</i>. This is the default mode used in CRS v3.x. ModSecurity will check an
HTTP request against all rules, and add a score to each matching rule. If a threshold is reached, then the
HTTP request is considered an attack and will be blocked. The default score for inbound requests is
5 and for outbound response is 4.

<img src="../../images/modsecurity-Anomaly-Scoring-debian-ubuntu.png"/>

When running in anomaly scoring mode, there are 4 paranoia levels.

<li>Paranoia level 1 (default)</li>
<li>Paranoia level 2</li>
<li>Paranoia level 3</li>
<li>Paranoia level 4</li>

With each paranoia level increase, the CRS enables additional rules giving you
a <b>higher level of security</b>. However, higher paranoia levels also increase the
possibility of <b>blocking some legitimate traffic</b> due to false positives.


<img src="../../images/modsecurity-Paranoia-Level-Initialization-debian-ubuntu.png"/>


These are the two basic concepts you need to understand before using the CRS.
Now we can close the file. The individual CRS rules are stored in
<i>/etc/apache2/modsecurity-crs/coreruleset-3.3.0/rules/</i> directory.
Each matching rule will increase the anomaly score.
</pre></div>
</div>
</div>
<!--## OWASP-CRS-Works-Testing #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-OWASP-CRS-Works-Testing">
<h2 class="foldable-title" id="foldable-title-OWASP-CRS-Works-Testing">OWASP-CRS-Works-Testing</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('OWASP-CRS-Works-Testing')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewbox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Security-WAF','editable-paragraph-OWASP-CRS-Works-Testing', 'foldable-content-penButton-OWASP-CRS-Works-Testing')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-OWASP-CRS-Works-Testing">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-OWASP-CRS-Works-Testing" onclick="save_editable_content('Security-WAF','editable-paragraph-OWASP-CRS-Works-Testing', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-OWASP-CRS-Works-Testing"><html><head></head><body><pre>To check if ModSecurity is working, you can launch a simple SQL injection attack on your own website.
(Please note that it’s illegal to do security testing on other people’s websites without authorization.)
Enter the following URL in your web browser.

<pre><code class="lang-bash">
https://yourdomain.com/?id=3 or 'a'='a'
</code></pre>

If ModSecurity is working properly, your Apache web server should return a 403 forbidden error message.
And in the audit log (<i>/var/log/apache2/modsec_audit.log</i>), you can see the following line in section H, which
means ModSecurity detected and blocked this SQL injection attack by using <b>OWASP CRS v3.3.0</b>.


<b>Action: Intercepted (phase 2)</b>
<img src="../../images/modsecurity-apache-Action-Intercepted-phase-2-debian-ubuntu.png"/>
When ModSecurity runs in DetectionOnly mode, it won’t block this SQL injection attack.


<h3>Understanding Modsecurity Logs</h3>
It’s important to analyze the ModSecurity logs, so you will know what kind of attacks are directed to your
web applications and take better actions to defend against threat actors. There are mainly two kinds of
logs in ModSecurity:

<li>debug log: disabled by default. </li>
<li> audit log: <i>/var/log/apache2/modsec_audit.log</i></li>

To understand ModSecurity audit logs, you need to know the 5 processing phases in ModSecurity, which are:

<li>Phase 1: Inspect request headers</li>
<li>Phase 2: Inspect request body</li>
<li>Phase 3: Inspect response headers</li>
<li>Phase 4: Inspect response body</li>
<li>Phase 5: Action (logging/blocking malicious requests)</li>

They are also two types of logging file.

<li><b>Serial</b>: one file for all logs. This is the default.</li>
<li><b>Concurrent</b>: multiple files for logging. This can provide better write performance. 
  If you can notice your web pages slowing down after enabling ModSecurity, you can
  choose to use the concurrent logging type.</li>

Events in the log are divided into several sections.


<li>section A: audit log header</li>
<li>section B: request header</li>
<li>section C: request body</li>
<li>section D: reserved</li>
<li>section E: intermediary response body</li>
<li>section F: final response headers</li>
<li>section G: reserved</li>
<li>section H: audit log trailer</li>
<li>section I: compact request body alternative, which excludes files</li>
<li>section J: information on uploaded files</li>
<li>section K: every rule matched by an event, in order of match</li>
<li>section Z: final boundary</li>


If you run a high traffic website, the ModSecurity audit log can get too large very quickly,
so we need to configure log rotation for the ModSecurity audit log. Create a logrotate
configuration file for ModSecurity.


<pre><code class="lang-bash">
sudo nano /etc/logrotate.d/modsecurity
</code></pre>


Add the following lines to this file.


<pre><code class="lang-bash">
/var/log/apache2/modsec_audit.log
{
        rotate 14
        daily
        missingok
        compress
        delaycompress
        notifempty
}
</code></pre>


This will rotate the log file every day (daily), compressing old versions (compress).
The previous 14 log files will be kept (rotate 14), and no rotation will occur if the
file is empty (notifempty). Save and close the file.


</pre></body></html></div>
</div>
</div>

<!--## OWASP-CRS-Handling-False-Positives #################################################################################################################-->
<div class="foldable-container" id="foldcontainer-OWASP-CRS-Handling-False-Positives">
<h2 class="foldable-title" id="foldable-title-OWASP-CRS-Handling-False-Positives">OWASP-CRS-Handling-False-Positives</h2>
<button class="foldable-content-unfoldbutton" id="foldable-content-unfoldbutton-newchapter" onclick="toggleFoldableContent('OWASP-CRS-Handling-False-Positives')" type="button">
<svg class="arrow-icon" fill="currentColor" height="16" viewbox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
<path d="M7 10l5 5 5-5H7z"></path>
</svg>
</button>
<button class="foldable-content-edittoggle" onclick="fetchEditableContent('Security-WAF','editable-paragraph-OWASP-CRS-Handling-False-Positives', 'foldable-content-penButton-OWASP-CRS-Handling-False-Positives')" type="button">
<svg class="wrench-icon" fill="currentColor" height="24" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M22.7 19.3l-4.1-4.1c.6-1.1.9-2.3.9-3.5 0-3.9-3.1-7-7-7-1.3 0-2.5.3-3.5.9l3.3 3.3-4 4-3.3-3.3C4.3 10.5 4 11.7 4 13c0 3.9 3.1 7 7 7 1.3 0 2.5-.3 3.5-.9l4.1 4.1c.4.4 1 .4 1.4 0l2.7-2.7c.4-.4.4-1 0-1.4z"></path>
</svg>
</button>
<div class="foldable-content folded" id="foldable-content-OWASP-CRS-Handling-False-Positives">
<button class="foldable-content-penButton-hidden" id="foldable-content-penButton-OWASP-CRS-Handling-False-Positives" onclick="save_editable_content('Security-WAF','editable-paragraph-OWASP-CRS-Handling-False-Positives', 'page-folder')" type="button">
<svg fill="none" height="30" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
<div class="editable-paragraph" contenteditable="false" id="editable-paragraph-OWASP-CRS-Handling-False-Positives"><h1>TITLE IPSUM</h1></div>
</div>
</div>
</div>
</div>
</div>
</body></html><!--## How-OWASP-CRS-Works #################################################################################################################--><!--## Steup-Apache2-Modsecurity #################################################################################################################-->